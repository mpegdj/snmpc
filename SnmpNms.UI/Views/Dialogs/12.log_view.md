# SNMPc 개발 로그 - Map Object Viewer 개선

## 날짜: 2024년

## 주요 개선 사항

### 1. Discovery 후 기기 자동 등록 시 CIDR 기반 서브넷 배치

**요구사항**: Discovery로 찾은 기기를 IP 주소의 CIDR에 따라 적절한 서브넷에 자동으로 배치

**구현 내용**:
- `DiscoveryPollingAgentsDialog.xaml.cs`에 다음 헬퍼 메서드 추가:
  - `IsIpInSubnet()`: IP 주소가 특정 Seed의 서브넷에 속하는지 확인
  - `NetmaskToCidrPrefix()`: Netmask를 CIDR prefix length로 변환 (예: `255.255.255.0` → `24`)
  - `CalculateNetworkAddress()`: IP 주소와 Netmask로 네트워크 주소 계산
  - `FindSubnetByName()`: 서브넷 이름으로 서브넷 찾기 (재귀)
  - `FindOrCreateSubnetForDevice()`: 기기 IP 주소에 맞는 서브넷을 찾거나 생성

**동작 방식**:
- Discovery로 기기를 추가할 때, Seed 목록에서 해당 IP가 속한 서브넷을 찾음
- 네트워크 주소와 CIDR prefix로 서브넷 이름 생성 (예: `192.168.0.0/24`)
- 서브넷이 없으면 생성 (RootSubnet 아래에 직접 생성)
- 매칭되는 Seed가 없으면 RootSubnet에 직접 추가

**파일**: `SnmpNms.UI/Views/Dialogs/DiscoveryPollingAgentsDialog.xaml.cs`

---

### 2. Auto Polling 로그 개선

**요구사항**: 
- Auto Polling 로그는 앱 시작 시에만 남기기
- 이후 Stop/Start 시에는 모든 기기가 polling되도록 하기
- 필터링은 표시에만 관련있고 polling에는 영향 없음

**구현 내용**:
- `MainWindow.xaml.cs`에 `_isInitialAutoPoll` 플래그 추가
- `ChkAutoPoll_Checked()`: 첫 번째 호출 시에만 "[System] Auto Polling Started" 로그 기록
- `ChkAutoPoll_Checked()`: 모든 기기를 polling에 추가 (SNMP Test 탭의 특정 IP가 아닌)
- `ChkAutoPoll_Unchecked()`: 모든 기기를 polling에서 제거, 로그 없음
- `StartPoll_Click()`: 선택과 무관하게 RootSubnet의 모든 기기를 polling에 추가, 로그 없음
- `StopPoll_Click()`: 선택과 무관하게 RootSubnet의 모든 기기를 polling에서 제거, 로그 없음

**파일**: `SnmpNms.UI/MainWindow.xaml.cs`

---

### 3. Default 서브넷 제거 제안

**요구사항**: 맨 처음 표시되는 "Default" 서브넷을 제거

**제안된 수정 사항**:

#### MainViewModel.cs
- `DefaultSubnet` 속성 제거
- 생성자에서 `DefaultSubnet` 생성 및 추가 코드 제거
- `AddDeviceToSubnet()`: `subnet ??= DefaultSubnet` → `subnet ??= RootSubnet`
- `AddSubnet()`: `parentSubnet ??= DefaultSubnet` → `parentSubnet ??= RootSubnet`
- `AddGoto()`: `parentSubnet ??= DefaultSubnet` → `parentSubnet ??= RootSubnet`

#### MainWindow.xaml.cs
- `GetSelectedSubnetOrDefault()`: `return _vm.DefaultSubnet` → `return _vm.RootSubnet`
- 메시지 수정: "[System] Map Selection Tree ready (Root Subnet/Default)." → "[System] Map Selection Tree ready (Root Subnet)."

#### DiscoveryPollingAgentsDialog.xaml.cs
- `FindOrCreateSubnetForDevice()`: `_mainViewModel.DefaultSubnet` → `_mainViewModel.RootSubnet`

#### MapViewControl.xaml.cs
- `DefaultSubnet` 참조 제거

**파일**: 
- `SnmpNms.UI/ViewModels/MainViewModel.cs`
- `SnmpNms.UI/MainWindow.xaml.cs`
- `SnmpNms.UI/Views/Dialogs/DiscoveryPollingAgentsDialog.xaml.cs`
- `SnmpNms.UI/Views/MapView/MapViewControl.xaml.cs`

---

### 4. IP/이름 표시 기능 (SNMPc 스타일)

**요구사항**: Map Object Viewer에서 IP로도 트리가 보이고 이름으로도 보이도록, Activity Bar의 toggle button으로 제어

**제안된 구현 방법**:

#### MainViewModel.cs
```csharp
private bool _showIpAddress = false; // 기본값: 이름만 표시
public bool ShowIpAddress
{
    get => _showIpAddress;
    set
    {
        if (_showIpAddress != value)
        {
            _showIpAddress = value;
            OnPropertyChanged();
            // 모든 MapNode의 DisplayName 갱신
            MapNode.ShowIpAddress = value;
            foreach (var deviceNode in DeviceNodes)
            {
                deviceNode.OnPropertyChanged(nameof(MapNode.DisplayName));
            }
        }
    }
}
```

#### MapNode.cs
```csharp
public static bool ShowIpAddress { get; set; } = false;

public string DisplayName =>
    NodeType switch
    {
        MapNodeType.Device => Target != null 
            ? (ShowIpAddress 
                ? $"{Target.DisplayName} ({Target.IpAddress}:{Target.Port})" 
                : Target.DisplayName)
            : Name,
        _ => Name
    };
```

#### Sidebar.xaml
- Map 버튼 옆에 IP 표시 토글 버튼 추가
- `ToggleButton`으로 구현하여 IP/이름 표시 전환

#### Sidebar.xaml.cs
- `BtnShowIp_Checked()`: `vm.ShowIpAddress = true`
- `BtnShowIp_Unchecked()`: `vm.ShowIpAddress = false`

**파일**: 
- `SnmpNms.UI/ViewModels/MainViewModel.cs`
- `SnmpNms.UI/Models/MapNode.cs`
- `SnmpNms.UI/Views/Sidebar.xaml`
- `SnmpNms.UI/Views/Sidebar.xaml.cs`

---

## 참고 사항

- 현재 ask 모드이므로 코드 변경은 제안만 제공됨
- 실제 구현 시 agent 모드로 전환하여 코드 수정 필요
- SNMPc 매뉴얼 참조: Map Object Viewer에서 IP/이름 표시 전환 기능
