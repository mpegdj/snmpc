<UserControl x:Class="SnmpNms.UI.Views.MapView.MapViewControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:SnmpNms.UI.Converters"
             xmlns:models="clr-namespace:SnmpNms.UI.Models"
             MinHeight="200" MinWidth="200"
             Loaded="UserControl_Loaded">
    <UserControl.Resources>
        <conv:DeviceStatusToBackgroundConverter x:Key="StatusBgConverter"/>
        <conv:DeviceStatusToBrushConverter x:Key="StatusBrushConverter"/>
        
        <!-- VSCode 스타일 아이콘 버튼 -->
        <Style x:Key="MapIconButton" TargetType="Button">
            <Setter Property="Width" Value="22"/>
            <Setter Property="Height" Value="22"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource VSCodeForeground}"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="2,0"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#3C3C3C"/>
                </Trigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="MapIconGlyph" TargetType="TextBlock">
            <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="{StaticResource VSCodeForeground}"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- VSCode 스타일 헤더 (모든 버튼 포함) -->
        <Border Grid.Row="0" Background="{StaticResource VSCodeSidebarBackground}" 
                BorderBrush="{StaticResource VSCodeDivider}" BorderThickness="0,0,0,1">
            <DockPanel Height="28">
                <!-- 우측 아이콘 버튼들 -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="4,0">
                    <!-- Search -->
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Search (Ctrl+F)" 
                            Click="ToggleSearch_Click" Name="btnSearch">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE721;"/>
                    </Button>
                    <Rectangle Width="1" Fill="{StaticResource VSCodeDivider}" Margin="4,4"/>
                    <!-- Add Site Table -->
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Add Site Table (click on canvas)" 
                            Click="AddSiteTable_Click" Name="btnAddSiteTable">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE710;"/>
                    </Button>
                    <Rectangle Width="1" Fill="{StaticResource VSCodeDivider}" Margin="4,4"/>
                    <!-- Zoom -->
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Zoom In" Click="ZoomIn_Click">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE8A3;"/>
                    </Button>
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Zoom Out" Click="ZoomOut_Click">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE71F;"/>
                    </Button>
                    <TextBlock Name="ZoomLevelText" Text="100%" VerticalAlignment="Center" Margin="4,0" 
                               Foreground="{StaticResource VSCodeForeground}" FontSize="11"/>
                    <Rectangle Width="1" Fill="{StaticResource VSCodeDivider}" Margin="4,4"/>
                    <!-- Grid/Snap -->
                    <CheckBox Name="ShowGridCheck" Content="Grid" IsChecked="True" 
                              Checked="ShowGrid_Changed" Unchecked="ShowGrid_Changed"
                              VerticalAlignment="Center" Foreground="{StaticResource VSCodeForeground}" FontSize="11"/>
                    <CheckBox Name="SnapToGridCheck" Content="Snap" IsChecked="True" 
                              VerticalAlignment="Center" Margin="6,0,0,0" Foreground="{StaticResource VSCodeForeground}" FontSize="11"/>
                    <Rectangle Width="1" Fill="{StaticResource VSCodeDivider}" Margin="4,4"/>
                    <!-- Auto Arrange -->
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Auto Arrange" Click="AutoArrange_Click">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE8CB;"/>
                    </Button>
                    <!-- Refresh -->
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Refresh" Click="Refresh_Click">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE72C;"/>
                    </Button>
                </StackPanel>
                
                <!-- 타이틀 -->
                <TextBlock Text="MAP VIEW" 
                           Foreground="{StaticResource VSCodeForeground}"
                           FontSize="11" FontWeight="SemiBold"
                           VerticalAlignment="Center" Margin="12,0,0,0"/>
            </DockPanel>
        </Border>
        
        <!-- 검색 패널 (토글) -->
        <Border Grid.Row="1" Name="SearchPanel" Visibility="Collapsed"
                Background="{StaticResource VSCodeSidebarBackground}" 
                BorderBrush="{StaticResource VSCodeDivider}" BorderThickness="0,0,0,1">
            <DockPanel Margin="8,6">
                <!-- 닫기 버튼 -->
                <Button DockPanel.Dock="Right" Style="{StaticResource MapIconButton}" 
                        ToolTip="Close" Click="CloseSearch_Click" Margin="4,0,0,0">
                    <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE711;" FontSize="12"/>
                </Button>
                
                <!-- 검색 결과 네비게이션 -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Margin="8,0,0,0">
                    <TextBlock Name="SearchResultText" Text="" VerticalAlignment="Center" 
                               Foreground="{StaticResource VSCodeForeground}" FontSize="11" Margin="0,0,6,0"/>
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Previous (Shift+Enter)" 
                            Click="SearchPrev_Click" Name="btnSearchPrev">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE70E;" FontSize="12"/>
                    </Button>
                    <Button Style="{StaticResource MapIconButton}" ToolTip="Next (Enter)" 
                            Click="SearchNext_Click" Name="btnSearchNext">
                        <TextBlock Style="{StaticResource MapIconGlyph}" Text="&#xE70D;" FontSize="12"/>
                    </Button>
                </StackPanel>
                
                <!-- 검색 범위 선택 -->
                <ComboBox DockPanel.Dock="Right" Name="SearchScopeCombo" Width="80" Margin="8,0,0,0"
                          VerticalAlignment="Center" FontSize="11" SelectedIndex="0"
                          SelectionChanged="SearchScope_Changed">
                    <ComboBoxItem Content="All"/>
                    <ComboBoxItem Content="Device"/>
                    <ComboBoxItem Content="Site"/>
                </ComboBox>
                
                <!-- 검색 입력 -->
                <Border BorderBrush="{StaticResource VSCodeDivider}" BorderThickness="1" 
                        Background="{StaticResource VSCodeEditorBackground}" CornerRadius="2">
                    <TextBox Name="SearchTextBox" BorderThickness="0" Padding="6,3"
                             Background="Transparent" Foreground="{StaticResource VSCodeForeground}"
                             FontSize="12" VerticalAlignment="Center"
                             KeyDown="SearchTextBox_KeyDown" TextChanged="SearchTextBox_TextChanged"/>
                </Border>
            </DockPanel>
        </Border>

        <!-- 메인 캔버스 영역 -->
        <Border Grid.Row="2" Margin="4" BorderBrush="{StaticResource VSCodeDivider}" 
                BorderThickness="1" Background="{StaticResource VSCodeEditorBackground}" CornerRadius="4"
                ClipToBounds="True">
            <ScrollViewer Name="MainScrollViewer" 
                          HorizontalScrollBarVisibility="Auto" 
                          VerticalScrollBarVisibility="Auto"
                          PanningMode="Both">
                <Canvas Name="MapCanvas" 
                        Width="2000" Height="1500"
                        Background="Transparent"
                        MouseLeftButtonDown="MapCanvas_MouseLeftButtonDown"
                        MouseWheel="MapCanvas_MouseWheel">
                    <Canvas.LayoutTransform>
                        <ScaleTransform x:Name="CanvasScale" ScaleX="1" ScaleY="1"/>
                    </Canvas.LayoutTransform>
                    
                    <!-- 그리드 점들 (코드에서 그림) -->
                    <Canvas Name="GridCanvas" IsHitTestVisible="False"/>
                    
                    <!-- Site 박스들 -->
                    <ItemsControl Name="SiteBoxesControl" Canvas.Left="0" Canvas.Top="0">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                    </ItemsControl>
                </Canvas>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>
