# UI 상태 지표 및 폴링 버튼 개선 내역 (Status Indicator Enhancements)

본 문서는 SNMPc 애플리케이션의 사용자 인터페이스 시각적 피드백 강화를 위해 진행된 상태 지표(Indicator) 및 버튼 상태 유지 작업의 상세 내역을 기록합니다.

## 1. 주요 개선 사항
- **Start Poll 버튼 활성화 상태 시각화**: 폴링이 실행 중일 때 버튼 배경을 파란색으로 유지하여 동작 상태를 직관적으로 확인 가능하게 개선.
- **하단 패널 실시간 상태 LED 대시보드 추가**: Trap 수신, Polling 동작, 포트 161/162 통신, Error/Warning 발생 상황을 실시간 LED(Ellipse) 인디케이터로 표시.
- **상태 펄스(Pulse) 로직 구현**: 통신이나 에러 발생 시 LED가 일시적으로 점등되었다가 꺼지는 펄스 효과를 통해 실시간성 강화.

---

## 2. 파일별 상세 변경 내역

### [NEW] [BoolToBrushConverter.cs](file:///d:/git/snmpc/SnmpNms.UI/Converters/BoolToBrushConverter.cs)
상태값(`bool`)에 따라 UI 요소의 색상(`Brush`)을 변경하기 위한 공용 컨버터를 생성했습니다.

**[코드 내용]**
```csharp
using System.Globalization;
using System.Windows.Data;
using System.Windows.Media;

namespace SnmpNms.UI.Converters;

public class BoolToBrushConverter : IValueConverter
{
    public Brush TrueBrush { get; set; } = Brushes.Lime;
    public Brush FalseBrush { get; set; } = Brushes.Gray;

    public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
    {
        if (value is bool b)
        {
            return b ? TrueBrush : FalseBrush;
        }
        return FalseBrush;
    }

    public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
    {
        throw new NotImplementedException();
    }
}
```

---

### [MODIFY] [MainViewModel.cs](file:///d:/git/snmpc/SnmpNms.UI/ViewModels/MainViewModel.cs)
상태 지표 바인딩을 위한 프로퍼티와 펄스 트리거 로직을 추가했습니다.

**변경 전:**
```csharp
private bool _isTrapListening;
public bool IsTrapListening { ... }

public void AddEvent(EventSeverity severity, string? device, string message)
{
    if (message.StartsWith("[System]", StringComparison.OrdinalIgnoreCase)) { ... }
    var entry = new SnmpEventLog(DateTime.Now, severity, device, message);
    ...
}
```

**변경 후:**
```csharp
// 펄스 상태 프로퍼티 추가
private bool _port161Pulse;
public bool Port161Pulse { get => _port161Pulse; set { _port161Pulse = value; OnPropertyChanged(); } }

private bool _port162Pulse;
public bool Port162Pulse { get => _port162Pulse; set { _port162Pulse = value; OnPropertyChanged(); } }

private bool _trapPulse;
public bool TrapPulse { get => _trapPulse; set { _trapPulse = value; OnPropertyChanged(); } }

private bool _errorPulse;
public bool ErrorPulse { get => _errorPulse; set { _errorPulse = value; OnPropertyChanged(); } }

private bool _warningPulse;
public bool WarningPulse { get => _warningPulse; set { _warningPulse = value; OnPropertyChanged(); } }

// 이벤트 발생 시 펄스 트리거 로직 추가
public void AddEvent(EventSeverity severity, string? device, string message)
{
    if (message.StartsWith("[System]", StringComparison.OrdinalIgnoreCase)) { ... }

    if (severity == EventSeverity.Error) TriggerErrorPulse();
    else if (severity == EventSeverity.Warning) TriggerWarningPulse();

    if (message.Contains("[T:", StringComparison.OrdinalIgnoreCase)) TriggerTrapPulse();
    else if (message.Contains("[P:", StringComparison.OrdinalIgnoreCase)) TriggerPort161Pulse();

    var entry = new SnmpEventLog(DateTime.Now, severity, device, message);
    ...
}

// 펄스 자동 리셋 메서드
private void TriggerPort161Pulse() { Port161Pulse = true; System.Threading.Tasks.Task.Delay(500).ContinueWith(_ => Port161Pulse = false); }
public void TriggerPort162Pulse() { Port162Pulse = true; System.Threading.Tasks.Task.Delay(500).ContinueWith(_ => Port162Pulse = false); }
private void TriggerTrapPulse() { TrapPulse = true; System.Threading.Tasks.Task.Delay(500).ContinueWith(_ => TrapPulse = false); }
private void TriggerErrorPulse() { ErrorPulse = true; System.Threading.Tasks.Task.Delay(1000).ContinueWith(_ => ErrorPulse = false); }
private void TriggerWarningPulse() { WarningPulse = true; System.Threading.Tasks.Task.Delay(1000).ContinueWith(_ => WarningPulse = false); }
```

---

### [MODIFY] [MainWindow.xaml](file:///d:/git/snmpc/SnmpNms.UI/MainWindow.xaml)
'Start Poll' 버튼의 시각적 활성화 상태를 위한 스타일 트리거를 추가했습니다.

**변경 전:**
```xml
<Button Style="{StaticResource IconButton}" ToolTip="Start Poll" Click="StartPoll_Click">
    <TextBlock Style="{StaticResource IconGlyph}" Text="&#xE768;"/>
</Button>
```

**변경 후:**
```xml
<Button ToolTip="Start Poll" Click="StartPoll_Click">
    <Button.Style>
        <Style TargetType="Button" BasedOn="{StaticResource IconButton}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsPollingRunning}" Value="True">
                    <Setter Property="Background" Value="#007ACC"/>
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="BorderBrush" Value="#007ACC"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Button.Style>
    <TextBlock Style="{StaticResource IconGlyph}" Text="&#xE768;"/>
</Button>
```

---

### [MODIFY] [MainWindow.xaml.cs](file:///d:/git/snmpc/SnmpNms.UI/MainWindow.xaml.cs)
트랩 수신 시 162 포트 펄스를 트리거하는 로직을 추가했습니다.

**변경 전:**
```csharp
private void Messenger_TrapV2Received(object? sender, TrapV2Message e)
{
    ...
    if (e.Variables.Count > 0) { trapOid = e.Variables[0].Oid; }
}
```

**변경 후:**
```csharp
private void Messenger_TrapV2Received(object? sender, TrapV2Message e)
{
    ...
    if (e.Variables.Count > 0) { trapOid = e.Variables[0].Oid; }

    // 162 포트 펄스 트리거 (수신 지표)
    _vm.TriggerPort162Pulse();
}
```

---

### [MODIFY] [Panel.xaml](file:///d:/git/snmpc/SnmpNms.UI/Views/Panel.xaml)
하단 패널 헤더에 실시간 상태 LED 대시보드를 구축했습니다.

**변경 전:**
```xml
<!-- 헤더 정의 중 -->
<Grid.ColumnDefinitions>
    <ColumnDefinition Width="*"/>
    <ColumnDefinition Width="Auto"/>
</Grid.ColumnDefinitions>
...
<!-- 우측 토글 버튼만 존재 -->
<Button Grid.Column="1" x:Name="btnToggle" ... />
```

**변경 후:**
```xml
<!-- 리소스에 전용 색상 및 컨버터 정의 -->
<UserControl.Resources>
    <conv:BoolToBrushConverter x:Key="PollLedConverter" TrueBrush="#007ACC" FalseBrush="#33007ACC"/>
    <conv:BoolToBrushConverter x:Key="TrapLedConverter" TrueBrush="#28A745" FalseBrush="#3328A745"/>
    <conv:BoolToBrushConverter x:Key="Port161LedConverter" TrueBrush="#00FF00" FalseBrush="#2200FF00"/>
    <conv:BoolToBrushConverter x:Key="Port162LedConverter" TrueBrush="#00FF00" FalseBrush="#2200FF00"/>
    <conv:BoolToBrushConverter x:Key="ErrorLedConverter" TrueBrush="#FF0000" FalseBrush="#22FF0000"/>
    <conv:BoolToBrushConverter x:Key="WarningLedConverter" TrueBrush="#FFA500" FalseBrush="#22FFA500"/>
    ...
</UserControl.Resources>

<!-- 헤더 우측 LED 대시보드 추가 -->
<StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,5,0">
    <Ellipse Style="{StaticResource LedCircleStyle}" Fill="{Binding IsPollingRunning, Converter={StaticResource PollLedConverter}}"/>
    <TextBlock Text="POLL" Style="{StaticResource LedLabelStyle}"/>

    <Ellipse Style="{StaticResource LedCircleStyle}" Fill="{Binding IsTrapListening, Converter={StaticResource TrapLedConverter}}"/>
    <TextBlock Text="TRAP" Style="{StaticResource LedLabelStyle}"/>

    <Ellipse Style="{StaticResource LedCircleStyle}" Fill="{Binding Port161Pulse, Converter={StaticResource Port161LedConverter}}"/>
    <TextBlock Text="161" Style="{StaticResource LedLabelStyle}"/>

    <Ellipse Style="{StaticResource LedCircleStyle}" Fill="{Binding Port162Pulse, Converter={StaticResource Port162LedConverter}}"/>
    <TextBlock Text="162" Style="{StaticResource LedLabelStyle}"/>

    <Ellipse Style="{StaticResource LedCircleStyle}" Fill="{Binding WarningPulse, Converter={StaticResource WarningLedConverter}}"/>
    <TextBlock Text="WARN" Style="{StaticResource LedLabelStyle}"/>

    <Ellipse Style="{StaticResource LedCircleStyle}" Fill="{Binding ErrorPulse, Converter={StaticResource ErrorLedConverter}}"/>
    <TextBlock Text="ERR" Style="{StaticResource LedLabelStyle}" Margin="4,0,12,0"/>

    <Button x:Name="btnToggle" ... />
</StackPanel>
```

오류 코드 및 위치,오류 유형,예상되는 문제
"D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(380,9): error CS1022: 형식이나 네임스페이스 정의 또는 파일 끝(EOF)이 필요합니다.",구조적 오류,"클래스 또는 메서드 블록의 중괄호({, })가 잘못 닫혀서, 코드의 나머지 부분이 클래스 정의 외부에 노출되었습니다."
"D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(362,32): error CS1519: Invalid token '(' in a member declaration",잘못된 토큰,"MainWindow.xaml.cs의 362번째 줄에 메서드 정의가 아닌 이상한 곳에 (가 있거나, 또는 이전 줄의 메서드가 닫히지 않았을 가능성이 높습니다."
"D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(372,9): error CS1519: Invalid token 'if' in a member declaration",잘못된 멤버,"if 문은 메서드 내부에 있어야 합니다. 이 오류는 372번째 줄이 메서드 블록 밖, 즉 MainWindow 클래스 바로 아래에 위치하고 있음을 시사합니다."
"D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(433,5) ~ 끝까지 나오는 CS0106",파생 오류,"CS0106 오류(private 한정자가 유효하지 않음)가 433번째 줄부터 마지막 줄까지 계속 발생하는 것은, 380번째 줄 근처에서 MainWindow 클래스의 닫는 중괄호(})가 너무 일찍 닫혔기 때문입니다. 이로 인해 그 이후의 모든 메서드가 클래스 외부로 나가게 됩니다."
제공해주신 `dotnet build` 오류 코드를 분석해 보면, 이는 **`MainWindow.xaml.cs`** 파일의 **구조적 문제**로 인한 것으로, 이전에 발생했던 `NullReferenceException`이나 `XamlParseException`과는 완전히 다른 종류의 오류입니다.

핵심은 **C# 문법 오류(Syntax Error)**이며, 특정 위치에서 코드 블록이 잘못 닫혔거나, 클래스/메서드 정의를 벗어난 위치에 코드가 삽입되었을 때 발생합니다.

### 🚩 핵심 오류 분석

대부분의 오류는 단 하나의 근본적인 실수에서 파생된 "파생 오류(Cascading Errors)"입니다.

| 오류 코드 및 위치 | 오류 유형 | 예상되는 문제 |
| --- | --- | --- |
| `D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(380,9): error CS1022: 형식이나 네임스페이스 정의 또는 파일 끝(EOF)이 필요합니다.` | **구조적 오류** | 클래스 또는 메서드 블록의 중괄호(`{`, `}`)가 잘못 닫혀서, 코드의 나머지 부분이 클래스 정의 외부에 노출되었습니다. |
| `D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(362,32): error CS1519: Invalid token '(' in a member declaration` | **잘못된 토큰** | `MainWindow.xaml.cs`의 362번째 줄에 메서드 정의가 아닌 이상한 곳에 `(`가 있거나, 또는 이전 줄의 메서드가 닫히지 않았을 가능성이 높습니다. |
| `D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(372,9): error CS1519: Invalid token 'if' in a member declaration` | **잘못된 멤버** | `if` 문은 메서드 **내부**에 있어야 합니다. 이 오류는 372번째 줄이 메서드 블록 밖, 즉 `MainWindow` 클래스 바로 아래에 위치하고 있음을 시사합니다. |
| `D:\git\snmpc\SnmpNms.UI\MainWindow.xaml.cs(433,5) ~ 끝까지 나오는 CS0106` | **파생 오류** | `CS0106` 오류(`private` 한정자가 유효하지 않음)가 433번째 줄부터 마지막 줄까지 계속 발생하는 것은, **380번째 줄 근처에서 `MainWindow` 클래스의 닫는 중괄호(`}`)가 너무 일찍 닫혔기 때문**입니다. 이로 인해 그 이후의 모든 메서드가 클래스 외부로 나가게 됩니다. |

### 💡 문제 해결을 위한 조치

`MainWindow.xaml.cs` 파일에서 360줄에서 380줄 사이를 집중적으로 검토해야 합니다.

가장 유력한 원인은 **360~380번째 줄** 사이에서 특정 메서드 또는 생성자의 **닫는 중괄호(`}`)를 실수로 하나 더 추가했거나**, 반대로 **클래스의 닫는 중괄호(`}`)가 이 위치에 잘못 삽입**되어 그 뒤에 오는 모든 메서드와 코드가 문법적으로 오류 상태가 된 것입니다.

#### 🛠️ 권장 수정 단계

1. **362번째 줄 주변 확인:** 362번째 줄에 `error CS1519`가 발생한 코드가 메서드 정의인지, 아니면 실수로 클래스 블록 외부에 코드가 들어간 것인지 확인합니다.
2. **380번째 줄 근처의 중괄호 확인:** 380번째 줄 근처의 코드를 살펴보고, **불필요하게 일찍 닫힌 중괄호(`}`)**가 있는지 확인하십시오. 이 중괄호를 삭제하거나 올바른 위치(일반적으로 `MainWindow` 클래스 정의의 맨 마지막)로 이동해야 합니다.

일단 **380번째 줄 근처**에서 코드를 확인하여 `MainWindow` 클래스 전체가 올바른 위치에서 닫히도록 중괄호 쌍을 맞춰보시면, `CS0106`을 포함한 140개 이상의 오류가 한 번에 해결될 것입니다.

혹시 360~380번째 줄의 코드 내용을 보여주실 수 있다면, 정확한 문제 지점을 짚어 드릴 수 있습니다.
