# Map Object View 검색 기능

## 1. 개요

Map View 탭과 Sidebar(Map Object View, MIB View)에 검색 기능을 추가했다.
VSCode 스타일의 검색 패널로 구현하여 일관된 UX를 제공한다.

## 2. Map View 검색 (MapViewControl)

### 2.1 UI 추가 (`MapViewControl.xaml`)
- **검색 버튼**: 헤더에 돋보기 아이콘 버튼 추가 (🔍)
- **검색 패널**: 토글 가능한 검색 패널
  - 검색 입력 필드
  - 검색 범위 선택: `All`, `Device`, `Site`
  - 이전/다음 결과 네비게이션 버튼
  - 결과 카운터 (예: "1 of 5")
  - 닫기 버튼

### 2.2 검색 로직 (`MapViewControl.xaml.cs`)
- **검색 범위**:
  - `All`: 모든 노드 (Device + Site)
  - `Device`: Device 노드만
  - `Site`: Subnet 노드만
- **검색 대상 필드**:
  - Name
  - DisplayName
  - IP 주소 (Device)
  - Alias

### 2.3 결과 네비게이션
- **Enter**: 다음 결과로 이동
- **Shift+Enter**: 이전 결과로 이동
- **Escape**: 검색 닫기
- 검색 결과 순환 (마지막 → 첫 번째)

### 2.4 위치 이동 및 하이라이트
- 검색 결과 선택 시 해당 Site Box로 스크롤
- Site Box에 파란색 테두리 하이라이트
- ViewModel 선택 상태 업데이트

## 3. Sidebar 검색 (SidebarMapView, SidebarMibView)

### 3.1 UI 구조

**Sidebar 헤더 (`Sidebar.xaml`)**
- 우측에 검색 토글 버튼 추가
- 현재 활성화된 뷰(Map 또는 MIB)에 따라 해당 검색 패널 열기

**검색 패널 (공통)**
- 검색 입력 필드
- 이전/다음 결과 네비게이션 버튼
- 결과 카운터 (예: "1/5")
- 닫기 버튼

### 3.2 SidebarMapView 검색 (`SidebarMapView.xaml.cs`)

**검색 대상 필드:**
- Name
- DisplayName
- IP 주소 (Device)
- Alias

**기능:**
- 검색 결과 노드의 부모들을 자동으로 확장
- TreeViewItem 선택 및 스크롤

### 3.3 SidebarMibView 검색 (`SidebarMibView.xaml.cs`)

**검색 대상 필드:**
- Name
- OID
- Description

**기능:**
- 검색 결과 노드까지의 경로를 자동으로 확장
- TreeViewItem 선택 및 스크롤

## 4. 키보드 단축키

| 단축키 | 동작 |
|--------|------|
| Enter | 다음 결과로 이동 |
| Shift+Enter | 이전 결과로 이동 |
| Escape | 검색 패널 닫기 |

## 5. 변경된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `MapViewControl.xaml` | 검색 버튼 및 검색 패널 UI 추가 |
| `MapViewControl.xaml.cs` | 검색 로직, 하이라이트, 스크롤 구현 |
| `Sidebar.xaml` | 검색 토글 버튼 추가 |
| `Sidebar.xaml.cs` | 검색 토글 핸들러 추가 |
| `SidebarMapView.xaml` | 검색 패널 UI 추가 |
| `SidebarMapView.xaml.cs` | Map Object 검색 로직 구현 |
| `SidebarMibView.xaml` | 검색 패널 UI 추가 |
| `SidebarMibView.xaml.cs` | MIB 노드 검색 로직 구현 |

## 6. 구현 세부사항

### 6.1 검색 패널 스타일 (공통)

```xml
<!-- 검색 패널용 아이콘 버튼 스타일 -->
<Style x:Key="SearchIconButton" TargetType="Button">
    <Setter Property="Width" Value="20"/>
    <Setter Property="Height" Value="20"/>
    <Setter Property="Background" Value="Transparent"/>
    <Setter Property="BorderThickness" Value="0"/>
    <Setter Property="Foreground" Value="{StaticResource VSCodeForeground}"/>
    <Setter Property="Cursor" Value="Hand"/>
    <Style.Triggers>
        <Trigger Property="IsMouseOver" Value="True">
            <Setter Property="Background" Value="#3C3C3C"/>
        </Trigger>
    </Style.Triggers>
</Style>
```

### 6.2 TreeView 노드 확장 및 선택

```csharp
private void ExpandToNode(MapNode node)
{
    // 부모 체인을 찾아서 모두 확장
    var parents = new List<MapNode>();
    var current = FindParent(node);
    while (current != null)
    {
        parents.Insert(0, current);
        current = FindParent(current);
    }
    
    foreach (var parent in parents)
    {
        parent.IsExpanded = true;
    }
}

private void SelectNodeInTreeView(MapNode node)
{
    var container = FindTreeViewItem(tvDevices, node);
    if (container != null)
    {
        container.IsSelected = true;
        container.BringIntoView();
        container.Focus();
    }
}
```

### 6.3 MIB 노드 경로 찾기 (Parent 속성 없음)

```csharp
private bool FindPathToNode(MibTreeNode current, MibTreeNode target, List<MibTreeNode> path)
{
    if (current == target)
    {
        return true;
    }
    
    foreach (var child in current.Children)
    {
        path.Add(current);
        if (FindPathToNode(child, target, path))
        {
            return true;
        }
        path.RemoveAt(path.Count - 1);
    }
    
    return false;
}
```

## 7. 향후 개선 사항

- [ ] Ctrl+F 전역 단축키 지원
- [ ] 검색 히스토리 저장
- [ ] 정규식 검색 지원
- [ ] 대소문자 구분 옵션
- [ ] 검색 결과 하이라이트 (TreeView 내)

[4 tools called]

이제 SidebarMapView.xaml.cs와 SidebarMibView.xaml.cs를 확인해서 검색 로직을 참고하겠습니다.

[3 tools called]

이제 MainViewModel을 확인해서 데이터 구조를 파악하겠습니다.

[1 tool called]

이제 충분한 정보를 수집했습니다. SidebarSearchView를 생성하겠습니다.

[3 tools called]

이제 IntToVisibilityConverter를 확인하고 추가해야 합니다.

[2 tools called]

IntToVisibilityConverter가 없으므로 추가해야 합니다. 또한 App.xaml에서 컨버터들이 어떻게 등록되어 있는지 확인하겠습니다.

[2 tools called]

이제 IntToVisibilityConverter를 생성하고 App.xaml에 등록하겠습니다.

[3 tools called]

이제 MainWindow.xaml.cs에서 Search 뷰를 연결하겠습니다.

[1 tool called]

이제 SearchView의 이벤트 핸들러를 추가해야 합니다. MainWindow.xaml.cs 끝 부분에 이벤트 핸들러를 추가하겠습니다.

[1 tool called]

이제 린트 오류를 확인하겠습니다.

[1 tool called]

린트 오류가 없습니다. 이제 빌드해서 확인해보겠습니다.

[2 tools called]

빌드가 성공했습니다. 이제 todo를 업데이트하고 문서를 업데이트하겠습니다.

[1 tool called]

검색 기능이 구현되었습니다! 구현된 내용을 요약하면:

## 구현 완료

### 1. SidebarSearchView.xaml
- VSCode 스타일의 검색 UI
- 검색 입력 필드 (돋보기 아이콘 + 지우기 버튼)
- 검색 범위 선택: All, Map, MIB
- 검색 결과 요약 표시
- Map 검색 결과 (Expander로 그룹화)
- MIB 검색 결과 (Expander로 그룹화)
- 결과 없음 메시지

### 2. SidebarSearchView.xaml.cs
- **Map 노드 검색**: Name, DisplayName, IP 주소, Alias
- **MIB 노드 검색**: Name, OID, Description
- 실시간 검색 (텍스트 입력 시 자동 검색)
- 검색 결과 클릭 시 이벤트 발생 (`MapNodeSelected`, `MibNodeSelected`)
- 아이콘/색상으로 노드 타입 및 상태 표시

### 3. MainWindow.xaml.cs 수정
- Search 뷰 선택 시 `SidebarSearchView` 생성 및 연결
- `SearchView_MapNodeSelected`: Map 뷰로 전환 후 해당 노드 선택
- `SearchView_MibNodeSelected`: MIB 뷰로 전환 후 해당 노드 선택

### 4. IntToVisibilityConverter 추가
- int 값이 0보다 크면 Visible, 아니면 Collapsed 반환
- 검색어 지우기 버튼 표시/숨김에 사용

이제 Activity Bar에서 검색 아이콘(🔍)을 클릭하면 통합 검색 기능을 사용할 수 있습니다!
맞습니다. 검색에서 Map 노드(Device)를 선택했을 때 MIB 관련 코드가 실행되면서 문제가 발생하는 것 같습니다. `SearchView_MapNodeSelected` 핸들러를 확인하고 수정하겠습니다.

[1 tool called]

문제를 찾았습니다. `SelectNode` 함수 내에서 Device를 선택할 때 MIB Table 탭 관련 코드가 실행되면서 문제가 발생할 수 있습니다. `SelectNode` 함수를 확인해보겠습니다.

[1 tool called]

문제를 찾았습니다! `SelectNode`에서 Device를 선택할 때:
1. SNMP Test 탭으로 자동 전환하려고 함
2. `_tvDevices`가 null일 수 있음 (Search 뷰에서 선택 시 Map 뷰가 아직 로드 안 됨)

`SearchView_MapNodeSelected`를 수정해서 Device 탭으로 이동하도록 하고, 안전하게 처리하겠습니다.

[1 tool called]

이제 `SearchView_MibNodeSelected`도 안전하게 수정하겠습니다.

[2 tools called]

닫는 괄호와 catch 블록을 추가해야 합니다.

[2 tools called]

이제 빌드해서 확인하겠습니다.

[1 tool called]

빌드 성공했습니다. 수정 내용:

## 수정 사항

### `SearchView_MapNodeSelected`
1. **try-catch 블록 추가**: 에러 발생 시 크래시 대신 로그 출력
2. **Device 선택 시 Device 탭으로 이동**: SNMP Test 탭 대신 Device 탭으로 이동
3. **SelectNode 대신 직접 처리**: `SelectNode`가 MIB Table 로드 등 부가 작업을 하므로, 검색에서는 최소한의 선택 로직만 실행
4. **Dispatcher로 TreeView 접근 지연**: Map 뷰 전환 후 TreeView가 완전히 로드된 후에 접근

### `SearchView_MibNodeSelected`
1. **try-catch 블록 추가**: 에러 발생 시 크래시 대신 로그 출력
2. **Dispatcher로 TreeView 접근 지연**: MIB 뷰 전환 후 TreeView가 완전히 로드된 후에 접근

이제 검색에서 Device를 선택하면:
- Map 뷰로 전환
- 해당 노드까지 트리 확장
- Device 탭으로 이동 (SNMP Test 대신)
- 에러가 발생해도 크래시 없이 로그만 출력

다시 테스트해 보세요!