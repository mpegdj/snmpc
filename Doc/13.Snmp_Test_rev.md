# SNMP Test 탭 개선 계획

## 목표
MIB View에서 선택한 OID를 SNMP Test 탭에서 쉽게 테스트할 수 있도록 연동 기능 추가

## 현재 상태

### 이미 구현된 기능
- ✅ MIB View에서 노드 선택 시 자동으로 SNMP Test 탭의 OID 필드에 채워짐
  - `treeMib_SelectedItemChanged` 이벤트 핸들러에서 처리 (1451-1458줄)
  - 탭 전환 없이 백그라운드에서 OID 필드만 업데이트
  - 이름이 있으면 이름 우선, 없으면 OID 사용

### 불필요한 부분 (제거 필요)
- ❌ 컨텍스트 메뉴의 "Send to SNMP Test" 항목
  - 자동 연동이 이미 구현되어 있어 불필요
  - 탭 전환을 하지 않으므로 의미가 없음
- ❌ `MibTreeSendToSnmpTest_Click` 이벤트 핸들러
  - 사용되지 않는 코드

## 작업 계획

### 1. 불필요한 코드 제거
- [ ] `SidebarMibView.xaml`에서 "Send to SNMP Test" 메뉴 항목 제거
- [ ] `SidebarMibView.xaml.cs`에서 `MibTreeSendToSnmpTest_Click` 이벤트 및 핸들러 제거
- [ ] `MainWindow.xaml.cs`에서 `MibTreeSendToSnmpTest_Click` 이벤트 핸들러 등록 코드 제거

### 2. 자동 연동 기능 확인 및 개선 (필요시)
- [ ] 현재 자동 연동이 정상 작동하는지 확인
- [ ] OID 필드 업데이트 로직이 안정적인지 확인
- [ ] 이름/OID 선택 로직이 적절한지 확인

## 구현 방식

### 옵션 1: 자동 연동 (선택됨)
- **동작**: MIB View에서 노드를 선택하면 자동으로 SNMP Test 탭의 OID 필드에 채워짐
- **장점**: 
  - 간단하고 빠름
  - 사용자가 추가 작업 없이 바로 테스트 가능
- **단점**: 
  - 사용자가 의도하지 않게 OID가 변경될 수 있음
- **구현 상태**: ✅ 이미 구현 완료

### 옵션 2: 컨텍스트 메뉴 (제외됨)
- **이유**: Editor View가 자동으로 바뀌면 안 되는 상황이 있을 수 있음
- 탭 전환 없이 OID만 채우는 방식도 고려했으나, 자동 연동으로 충분함

## 사용자 시나리오

1. 사용자가 MIB View에서 원하는 OID 노드를 선택
2. SNMP Test 탭의 OID 필드가 자동으로 업데이트됨 (탭 전환 없음)
3. 사용자가 Get/Get Next/Walk 버튼을 클릭하여 테스트 수행

---

# SNMP Test 탭 개선 작업 내역

## 1. Splitter 추가 (Map Object View ↔ Editor View)

### 목표
Map Object View와 Editor View 사이에 리사이즈 가능한 splitter 추가

### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml`
- **변경 사항**:
  - 메인 Grid에 `ColumnDefinitions` 추가:
    - `ColumnDefinition Width="280" MinWidth="200" MaxWidth="600"` (Sidebar)
    - `ColumnDefinition Width="Auto"` (GridSplitter)
    - `ColumnDefinition Width="*"` (TabControl)
  - `GridSplitter` 추가:
    - `Width="4"`
    - `ResizeDirection="Columns"`
    - `ShowsPreview="False"`
    - `Background="{StaticResource VSCodeDivider}"`
  - `TabControl`의 `Grid.Column`을 "2"로 변경

### 결과
- 사용자가 splitter를 드래그하여 좌우 패널 크기 조정 가능
- VS Code 스타일의 UI 제공

---

## 2. Get Next 및 Walk 버튼 추가

### 목표
SNMP Test 탭에 Get Next와 Walk 기능 추가

### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml`, `SnmpNms.UI/MainWindow.xaml.cs`
- **변경 사항**:
  - "Get Next" 버튼 추가 (`btnGetNext`)
  - "Walk" 버튼 추가 (`btnWalk`)
  - "Stop" 버튼 추가 (`btnStopWalk`) - Walk 취소용
  - 결과 표시 영역 추가 (`txtSnmpResult`)

### 기능 상세
- **Get Next**: 
  - 현재 OID의 다음 OID를 조회
  - 성공 시 `txtOid.Text`를 다음 OID로 업데이트하여 연속 조회 가능
  - MIB View의 선택 노드도 자동으로 동기화
- **Walk**: 
  - 지정된 OID의 하위 트리를 모두 순회
  - `WalkMode.WithinSubtree` 사용하여 하위 OID만 조회
  - 취소 가능 (CancellationToken 사용)
  - 결과를 OID 순으로 정렬하여 표시

### 문제 및 해결
- **문제**: Get Next가 같은 OID를 2번 실행
  - **원인**: `treeMib_SelectedItemChanged`에서 OID 업데이트 시 Get Next의 OID 업데이트를 덮어씀
  - **해결**: `_isUpdatingOidFromGetNext` 플래그 추가하여 Get Next 업데이트 중에는 MIB View 선택 이벤트 무시

- **문제**: Walk가 인스턴스 OID(.0)에서 작동하지 않음
  - **원인**: `WalkMode.WithinSubtree`는 스칼라 OID에 대해 하위 트리를 순회하는데, 인스턴스 OID(.0)는 스칼라 OID가 아님
  - **해결**: Walk 실행 전에 OID에서 `.0` 제거하여 스칼라 OID로 변환

- **문제**: Get Next 첫 클릭 시 `.0`이 자동으로 추가되고 현재 OID가 한 번 실행됨
  - **원인**: MIB View에서 스칼라 OID 선택 시 `.0`이 추가되지 않아 Get Next에서 추가하려고 시도
  - **해결**: MIB View에서 스칼라 OID 선택 시 자동으로 `.0` 추가하도록 `treeMib_SelectedItemChanged` 수정

---

## 3. SNMP Test 결과 표시 개선

### 목표
SNMP Test 결과를 더 자세하고 읽기 쉽게 표시

### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml`, `SnmpNms.UI/MainWindow.xaml.cs`
- **변경 사항**:
  - 결과 표시 형식: `[Index/Total] | OID Name | OID | Type | Value`
  - OID Name에서 `(oid)` 제거
  - 상태 메시지 영역 추가 (`txtSnmpStatus`)
  - Walk 성공 시 소요 시간 표시

### 레이아웃 변경
- 결과 영역을 상단으로 이동 (입력 필드 바로 아래)
- 상태 메시지 영역을 버튼과 같은 높이에 배치
- 결과 영역이 남은 공간을 모두 사용하도록 설정

---

## 4. MIB View OID 필터링 기능

### 목표
선택된 디바이스에 맞는 OID만 MIB View에 표시

### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml.cs`, `SnmpNms.Core/Models/MibTreeNode.cs`, `SnmpNms.UI/Views/SidebarMibView.xaml`
- **변경 사항**:
  - `MibTreeNode`에 `IsVisible` 속성 추가
  - `FilterMibTreeByDevice` 메서드 추가
  - `FilterMibTreeNode` 재귀 메서드 추가
  - `ResetMibTreeFilter` 메서드 추가
  - `SidebarMibView.xaml`에 `Visibility` 바인딩 추가

### 동작 방식
1. 디바이스 선택 시:
   - 디바이스의 `SysObjectId`에서 Enterprise OID 추출 (예: `1.3.6.1.4.1.3930.36`)
   - Private 노드의 자식 중 해당 Enterprise OID와 일치하는 노드만 표시
   - 부모 노드(예: `nel`)는 자식이 표시되면 자동으로 표시

2. 디바이스 선택 해제 시:
   - 모든 노드 표시 (`ResetMibTreeFilter`)

### 문제 및 해결

#### 문제 1: nel 하위 노드가 사라지는 문제

**증상**: 디바이스를 선택하면 `nel` 노드는 보이지만 그 하위 노드(mve5000, mvd5000)가 사라짐

**원인 분석**:
1. `FilterMibTreeNode`에서 `nel` 노드(1.3.6.1.4.1.3930)는 `enterpriseOid`(예: 1.3.6.1.4.1.3930.36)와 정확히 일치하지 않음
2. `nel` 노드는 `enterpriseOid`의 부모이므로 `isMatch = false`
3. `hasMatchingChild`를 확인하는데, 재귀적으로 자식을 먼저 필터링하므로:
   - 자식(mve5000, mvd5000)이 매칭되면 `hasMatchingChild = true`가 되어야 함
   - 하지만 자식이 매칭되지 않으면 `hasMatchingChild = false`가 되어 `nel` 노드가 숨겨짐

**해결 방법**:
- `FilterMibTreeNode`에서 부모 노드(`nel`)가 표시되도록 보장
- `nel` 노드의 OID가 `enterpriseOid`의 부모인지 확인하는 로직 추가 필요
- 또는 `nel` 노드를 항상 표시하도록 예외 처리 추가

**현재 상태**: 
- `ResetMibTreeNodeFilter(rootNode)`를 호출하여 모든 노드를 먼저 표시한 후 필터링
- 하지만 필터링 로직에서 `nel` 노드가 자식이 없으면 숨겨지는 문제가 있음

#### 문제 2: mvd5000이 IMPORTS로 표시되는 문제

**증상**: MIB View에서 mvd5000 노드가 "IMPORTS"로 표시됨

**원인 분석**:
1. `BuildTreeFromOids`에서 중간 세그먼트 이름을 찾을 때 `_oidToName.TryGetValue(fullOid, out var segmentName)`를 사용
2. 만약 `1.3.6.1.4.1.3930.37`에 대한 이름이 "IMPORTS"로 잘못 등록되어 있다면 그 이름이 사용됨
3. MIB 파일 파싱 시 "IMPORTS" 키워드가 OID로 잘못 파싱되었을 가능성

**해결 방법**:
1. `Register` 메서드에서 키워드 필터링 추가 (완료)
   - "IMPORTS", "EXPORTS", "FROM", "BEGIN", "END" 등 키워드는 등록하지 않음
   - 소문자로 시작하지 않는 이름도 등록하지 않음

2. `BuildTreeFromOids`에서 중간 세그먼트 이름 검증 강화 (완료)
   - 찾은 이름이 유효한지 확인 (소문자로 시작하는지, 키워드가 아닌지)
   - 유효하지 않은 이름이면 세그먼트 번호 사용

3. MIB 파일 파서 정규식 개선 (완료)
   - `OBJECT IDENTIFIER`, `MODULE-IDENTITY`, `OBJECT-TYPE` 파싱 시 소문자로 시작하는 이름만 매칭
   - "IMPORTS", "EXPORTS" 같은 대문자 키워드는 파싱되지 않음

**현재 상태**:
- `Register` 메서드에서 키워드 필터링 추가 완료
- `BuildTreeFromOids`에서 이름 검증 강화 완료
- MIB 파일 파서 정규식 개선 완료
- 하지만 이미 등록된 잘못된 데이터는 남아있을 수 있음 (애플리케이션 재시작 필요)

---

## 5. MIB 트리 정렬 개선

### 목표
MIB 트리 노드를 OID 숫자 순으로 정렬

### 구현 내용
- **파일**: `SnmpNms.Infrastructure/MibService.cs`
- **변경 사항**:
  - `SortTree` 메서드에서 `OrderBy(c => c.Name)` 대신 `CompareOidForSort(c.Oid)` 사용
  - `CompareOidForSort` 메서드 추가: OID 세그먼트를 숫자로 변환하여 정렬 가능한 문자열 생성

### 결과
- MIB 트리 노드가 OID 숫자 순으로 정렬되어 표시됨
- 예: `1.3.6.1.2.1.1.1`이 `1.3.6.1.2.1.1.10`보다 먼저 표시됨

---

## 6. MIB View에서 Private OID 선택 시 디바이스 자동 선택

### 목표
MIB View에서 Private OID를 선택하면 해당 OID를 지원하는 첫 번째 디바이스를 자동으로 선택하고 SNMP Test 탭의 IP/Community 업데이트

### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml.cs`
- **변경 사항**:
  - `treeMib_SelectedItemChanged`에서 Private OID 선택 시 `FindDeviceSupportingOid` 호출
  - `FindDeviceSupportingOid` 메서드 추가: 선택된 OID를 지원하는 디바이스 찾기
  - `ExtractEnterpriseOid` 메서드 추가: OID에서 Enterprise OID 추출
  - 디바이스를 찾으면 SNMP Test 탭의 IP/Community 업데이트 및 디바이스 선택

---

## 7. 디바이스 선택에 따른 MIB View 필터링

### 목표
Map Object View에서 디바이스를 선택하면 해당 디바이스의 Enterprise OID와 일치하는 노드만 MIB View에 표시

### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml.cs`
- **변경 사항**:
  - `SelectNode`에서 디바이스 선택 시 `FilterMibTreeByDevice` 호출
  - `FilterMibTreeByDevice` 메서드: 디바이스의 `SysObjectId`에서 Enterprise OID 추출 후 필터링
  - `FilterMibTreeNode` 재귀 메서드: 노드와 자식을 필터링
  - `ResetMibTreeFilter` 메서드: 필터 리셋 (모든 노드 표시)

### 동작 방식
1. 디바이스 선택 시:
   - 디바이스의 `SysObjectId`에서 Enterprise OID 추출 (예: `1.3.6.1.4.1.3930.36`)
   - Private 노드의 자식 중 해당 Enterprise OID와 일치하는 노드만 표시
   - 부모 노드(예: `nel`)는 자식이 표시되면 자동으로 표시

2. 디바이스 선택 해제 시:
   - 모든 노드 표시 (`ResetMibTreeFilter`)

---

## 8. 문제 분석 및 해결 방안

### 문제 1: nel 하위 노드가 사라지는 문제

#### 증상
디바이스를 선택하면 `nel` 노드(1.3.6.1.4.1.3930)는 보이지만 그 하위 노드(mve5000, mvd5000)가 사라짐

#### 원인 분석
1. **필터링 로직의 문제**:
   - `FilterMibTreeNode`에서 `nel` 노드(1.3.6.1.4.1.3930)는 `enterpriseOid`(예: 1.3.6.1.4.1.3930.36)와 정확히 일치하지 않음
   - `nel` 노드는 `enterpriseOid`의 부모이므로 `isMatch = false`
   - `hasMatchingChild`를 확인하는데, 재귀적으로 자식을 먼저 필터링하므로:
     - 자식(mve5000, mvd5000)이 매칭되면 `hasMatchingChild = true`가 되어야 함
     - 하지만 자식이 매칭되지 않으면 `hasMatchingChild = false`가 되어 `nel` 노드가 숨겨짐

2. **필터링 전 초기화 문제**:
   - `ResetMibTreeNodeFilter(rootNode)`를 호출하여 모든 노드를 먼저 표시한 후 필터링
   - 하지만 필터링 로직에서 `nel` 노드가 자식이 없으면 숨겨지는 문제가 있음

#### 해결 방안
1. **부모 노드 예외 처리 추가**:
   - `nel` 노드(1.3.6.1.4.1.3930)는 항상 표시하도록 예외 처리 추가
   - 또는 `enterpriseOid`의 부모 노드는 항상 표시하도록 로직 수정

2. **필터링 로직 개선**:
   - `nel` 노드의 OID가 `enterpriseOid`의 부모인지 확인하는 로직 추가
   - 부모 노드인 경우 자식이 매칭되면 항상 표시

#### 현재 상태
- `ResetMibTreeNodeFilter(rootNode)`를 호출하여 모든 노드를 먼저 표시한 후 필터링
- 하지만 필터링 로직에서 `nel` 노드가 자식이 없으면 숨겨지는 문제가 있음
- **추가 작업 필요**: 부모 노드 예외 처리 추가

### 문제 2: mvd5000이 IMPORTS로 표시되는 문제

#### 증상
MIB View에서 mvd5000 노드가 "IMPORTS"로 표시됨

#### 원인 분석
1. **MIB 파일 파싱 문제**:
   - MIB 파일에서 "IMPORTS" 키워드가 OID로 잘못 파싱되었을 가능성
   - 정규식이 대문자로 시작하는 키워드를 매칭했을 수 있음

2. **트리 빌드 시 이름 할당 문제**:
   - `BuildTreeFromOids`에서 중간 세그먼트 이름을 찾을 때 `_oidToName.TryGetValue(fullOid, out var segmentName)`를 사용
   - 만약 `1.3.6.1.4.1.3930.37`에 대한 이름이 "IMPORTS"로 잘못 등록되어 있다면 그 이름이 사용됨

3. **이미 등록된 잘못된 데이터**:
   - `Register` 메서드에서 키워드 필터링을 추가했지만, 이미 등록된 데이터는 남아있을 수 있음

#### 해결 방안
1. **Register 메서드 개선** (완료):
   - "IMPORTS", "EXPORTS", "FROM", "BEGIN", "END" 등 키워드는 등록하지 않음
   - 소문자로 시작하지 않는 이름도 등록하지 않음

2. **BuildTreeFromOids 개선** (완료):
   - 찾은 이름이 유효한지 확인 (소문자로 시작하는지, 키워드가 아닌지)
   - 유효하지 않은 이름이면 세그먼트 번호 사용

3. **MIB 파일 파서 정규식 개선** (완료):
   - `OBJECT IDENTIFIER`, `MODULE-IDENTITY`, `OBJECT-TYPE` 파싱 시 소문자로 시작하는 이름만 매칭
   - "IMPORTS", "EXPORTS" 같은 대문자 키워드는 파싱되지 않음

#### 현재 상태
- `Register` 메서드에서 키워드 필터링 추가 완료
- `BuildTreeFromOids`에서 이름 검증 강화 완료
- MIB 파일 파서 정규식 개선 완료
- 하지만 이미 등록된 잘못된 데이터는 남아있을 수 있음 (애플리케이션 재시작 필요)

---

## 9. 향후 개선 사항

### 우선순위 높음
1. **nel 하위 노드 사라지는 문제 해결**:
   - 부모 노드 예외 처리 추가
   - 필터링 로직 개선

2. **MIB 파일 재파싱**:
   - 애플리케이션 재시작하여 잘못된 데이터 제거
   - 또는 MIB 파일 파싱 시 기존 데이터 초기화

### 우선순위 중간
1. **필터링 성능 개선**:
   - 대량의 노드가 있을 때 필터링 성능 최적화

2. **필터링 UI 개선**:
   - 필터링 상태 표시
   - 필터 리셋 버튼 추가

### 우선순위 낮음
1. **MIB 파일 파서 개선**:
   - 더 많은 SMIv2 문법 지원
   - 테이블 자동 감지

---

## 10. 변경 이력

- **2024-12-XX**: SNMP Test 탭 개선 작업 시작
  - Splitter 추가
  - Get Next 및 Walk 버튼 추가
  - 결과 표시 개선
  - MIB View OID 필터링 기능 추가
  - MIB 트리 정렬 개선
  - 디바이스 선택에 따른 MIB View 필터링 구현
  - 문제 분석 및 해결 방안 문서화
