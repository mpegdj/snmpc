# Trap Listener 엔진 구현 계획

이 문서는 **SNMP Trap Listener 엔진** 구현을 위한 상세 계획서입니다.  
Trap Listener는 NMS의 핵심 엔진 중 하나로, UDP 포트 162에서 SNMP Trap을 수신하고 처리합니다.

---

## 목표

- UDP 포트 162에서 SNMP Trap 수신
- SNMP v1/v2c Trap 파싱 및 처리
- Trap 정보를 Event Log에 기록
- MIB 이름 변환 연동 (가능한 범위)
- PollingService와 유사한 엔진 패턴으로 구현

---

## 아키텍처 설계

### 레이어 구조

```
SnmpNms.Core (인터페이스/계약)
  └─ Interfaces/
      └─ ITrapListener.cs          ← Trap 엔진 인터페이스
  └─ Models/
      └─ TrapEvent.cs              ← Trap 이벤트 모델

SnmpNms.Infrastructure (구현체/엔진)
  └─ TrapListener.cs               ← Trap 엔진 구현체

SnmpNms.UI (UI 연동)
  └─ MainWindow.xaml.cs           ← Trap 수신 이벤트를 Event Log에 연결
```

### PollingService와의 유사성

TrapListener는 PollingService와 동일한 엔진 패턴을 따릅니다:

- **백그라운드 서비스**: 독립적으로 실행되는 엔진
- **Start/Stop 패턴**: `Start()`, `Stop()` 메서드로 제어
- **이벤트 기반**: `OnTrapReceived` 이벤트로 Trap 전달
- **Infrastructure 레이어**: 네트워크 통신과 프로토콜 파싱 담당

---

## 구현 상세

### 1. Core 레이어: 인터페이스 정의

#### 1.1 `ITrapListener` 인터페이스

**파일**: `SnmpNms.Core/Interfaces/ITrapListener.cs`

```csharp
using SnmpNms.Core.Models;

namespace SnmpNms.Core.Interfaces;

public interface ITrapListener
{
    bool IsListening { get; }
    
    void Start(int port = 162);
    void Stop();
    
    event EventHandler<TrapEvent> OnTrapReceived;
}
```

**설명**:
- `IsListening`: 현재 리스닝 중인지 확인
- `Start(port)`: UDP 포트에서 Trap 수신 시작 (기본값 162)
- `Stop()`: Trap 수신 중지
- `OnTrapReceived`: Trap 수신 시 발생하는 이벤트

---

### 2. Core 레이어: 모델 정의

#### 2.1 `TrapEvent` 모델

**파일**: `SnmpNms.Core/Models/TrapEvent.cs`

```csharp
namespace SnmpNms.Core.Models;

public class TrapEvent
{
    public DateTime Timestamp { get; }
    public string SourceIpAddress { get; }
    public int SourcePort { get; }
    public SnmpVersion Version { get; }
    public string? Community { get; }
    public string? EnterpriseOid { get; }
    public string? GenericTrapType { get; }
    public string? SpecificTrapType { get; }
    public List<SnmpVariable> Variables { get; }
    public string? ErrorMessage { get; }

    public TrapEvent(
        string sourceIpAddress,
        int sourcePort,
        SnmpVersion version,
        string? community = null,
        string? enterpriseOid = null,
        string? genericTrapType = null,
        string? specificTrapType = null,
        List<SnmpVariable>? variables = null,
        string? errorMessage = null)
    {
        Timestamp = DateTime.Now;
        SourceIpAddress = sourceIpAddress;
        SourcePort = sourcePort;
        Version = version;
        Community = community;
        EnterpriseOid = enterpriseOid;
        GenericTrapType = genericTrapType;
        SpecificTrapType = specificTrapType;
        Variables = variables ?? new List<SnmpVariable>();
        ErrorMessage = errorMessage;
    }
}
```

**필드 설명**:
- `Timestamp`: Trap 수신 시간
- `SourceIpAddress`: Trap을 보낸 장비의 IP 주소
- `SourcePort`: Trap을 보낸 장비의 포트
- `Version`: SNMP 버전 (V1/V2c/V3)
- `Community`: SNMP 커뮤니티 문자열 (v1/v2c)
- `EnterpriseOid`: SNMPv1 Trap의 Enterprise OID
- `GenericTrapType`: SNMPv1 Trap의 Generic Trap 타입
- `SpecificTrapType`: SNMPv1 Trap의 Specific Trap 타입
- `Variables`: Trap에 포함된 SNMP 변수들 (VarBind)
- `ErrorMessage`: 파싱 오류 시 에러 메시지

**SNMPv1 vs SNMPv2c 차이**:
- **SNMPv1**: EnterpriseOid, GenericTrapType, SpecificTrapType 포함
- **SNMPv2c**: 첫 번째 변수가 sysUpTime, 두 번째가 snmpTrapOID

---

### 3. Infrastructure 레이어: 구현체

#### 3.1 `TrapListener` 구현

**파일**: `SnmpNms.Infrastructure/TrapListener.cs`

**의존성**:
- `System.Net.Sockets.UdpClient`: UDP 소켓 통신
- `Lextm.SharpSnmpLib`: SNMP 메시지 파싱
- `System.Threading.Tasks`: 비동기 처리

**주요 구성 요소**:

1. **UDP 소켓 관리**
   - `UdpClient`: UDP 포트 162 리스닝
   - `CancellationTokenSource`: 비동기 작업 취소 제어
   - `Task`: 백그라운드 리스닝 작업

2. **Trap 수신 루프**
   - `ListenAsync()`: 무한 루프로 UDP 패킷 수신
   - `ReceiveAsync()`: 비동기로 UDP 패킷 대기
   - 예외 처리: 네트워크 오류 시 에러 TrapEvent 발생

3. **Trap 파싱**
   - `ProcessTrap()`: 수신한 바이트 배열을 SNMP 메시지로 파싱
   - `MessageFactory.ParseMessage()`: SharpSnmpLib로 메시지 파싱
   - PDU 타입별 처리:
     - `TrapV1Pdu`: SNMPv1 Trap
     - `TrapV2Pdu`: SNMPv2c Trap
     - `InformRequestPdu`: SNMP Inform (선택적 지원)

4. **이벤트 발생**
   - `OnTrapReceived` 이벤트로 파싱된 TrapEvent 전달

**구현 세부사항**:

```csharp
public class TrapListener : ITrapListener
{
    private UdpClient? _udpClient;
    private CancellationTokenSource? _cancellationTokenSource;
    private Task? _listeningTask;
    private int _port;

    public bool IsListening => _udpClient != null && 
                               _listeningTask != null && 
                               !_listeningTask.IsCompleted;

    public event EventHandler<TrapEvent>? OnTrapReceived;

    public void Start(int port = 162)
    {
        // 이미 리스닝 중이면 중지 후 재시작
        if (IsListening) Stop();

        _port = port;
        _cancellationTokenSource = new CancellationTokenSource();
        
        try
        {
            _udpClient = new UdpClient(port);
            _listeningTask = Task.Run(() => ListenAsync(_cancellationTokenSource.Token));
        }
        catch (SocketException ex)
        {
            throw new InvalidOperationException(
                $"Failed to start Trap Listener on port {port}: {ex.Message}", ex);
        }
    }

    public void Stop()
    {
        // 취소 토큰으로 리스닝 루프 종료
        _cancellationTokenSource?.Cancel();
        
        // UDP 소켓 닫기
        try { _udpClient?.Close(); } catch { }
        
        // 리소스 정리
        _udpClient = null;
        _cancellationTokenSource?.Dispose();
        _cancellationTokenSource = null;
        
        // 작업 완료 대기 (최대 1초)
        try { _listeningTask?.Wait(1000); } catch { }
        _listeningTask = null;
    }

    private async Task ListenAsync(CancellationToken cancellationToken)
    {
        // 무한 루프로 UDP 패킷 수신
        while (!cancellationToken.IsCancellationRequested)
        {
            try
            {
                var result = await _udpClient.ReceiveAsync(cancellationToken);
                ProcessTrap(result.Buffer, result.RemoteEndPoint);
            }
            catch (OperationCanceledException)
            {
                break; // 정상 종료
            }
            catch (Exception ex)
            {
                // 에러 발생 시 에러 TrapEvent 발생
                OnTrapReceived?.Invoke(this, new TrapEvent(
                    "0.0.0.0", 0, SnmpVersion.V2c,
                    errorMessage: $"Trap receive error: {ex.Message}"));
            }
        }
    }

    private void ProcessTrap(byte[] buffer, IPEndPoint remoteEndPoint)
    {
        try
        {
            // SharpSnmpLib로 메시지 파싱
            var message = MessageFactory.ParseMessage(buffer, 0, buffer.Length);
            
            // SNMP 버전 매핑
            SnmpVersion version = message.VersionCode switch
            {
                VersionCode.V1 => SnmpVersion.V1,
                VersionCode.V2 => SnmpVersion.V2c,
                VersionCode.V3 => SnmpVersion.V3,
                _ => SnmpVersion.V2c
            };

            // 커뮤니티 문자열 추출 (v1/v2c)
            string? community = null;
            if (message is IMessage v1v2Message)
            {
                community = v1v2Message.Parameters.UserName?.ToString();
            }

            // PDU 타입별 처리
            string? enterpriseOid = null;
            string? genericTrapType = null;
            string? specificTrapType = null;
            List<SnmpVariable> variables = new();

            if (message.Pdu() is TrapV1Pdu trapV1)
            {
                // SNMPv1 Trap 처리
                enterpriseOid = trapV1.Enterprise.ToString();
                genericTrapType = trapV1.Generic.ToString();
                specificTrapType = trapV1.Specific.ToString();
                
                foreach (var v in trapV1.Variables)
                {
                    variables.Add(new SnmpVariable(
                        v.Id.ToString(),
                        v.Data.ToString(),
                        v.Data.TypeCode.ToString()));
                }
            }
            else if (message.Pdu() is TrapV2Pdu trapV2)
            {
                // SNMPv2c Trap 처리
                foreach (var v in trapV2.Variables)
                {
                    variables.Add(new SnmpVariable(
                        v.Id.ToString(),
                        v.Data.ToString(),
                        v.Data.TypeCode.ToString()));
                }
            }
            else if (message.Pdu() is InformRequestPdu inform)
            {
                // SNMP Inform 처리 (선택적)
                foreach (var v in inform.Variables)
                {
                    variables.Add(new SnmpVariable(
                        v.Id.ToString(),
                        v.Data.ToString(),
                        v.Data.TypeCode.ToString()));
                }
            }
            else
            {
                // 기타 PDU 타입
                var pdu = message.Pdu();
                if (pdu != null)
                {
                    foreach (var v in pdu.Variables)
                    {
                        variables.Add(new SnmpVariable(
                            v.Id.ToString(),
                            v.Data.ToString(),
                            v.Data.TypeCode.ToString()));
                    }
                }
            }

            // TrapEvent 생성 및 이벤트 발생
            var trapEvent = new TrapEvent(
                remoteEndPoint.Address.ToString(),
                remoteEndPoint.Port,
                version,
                community,
                enterpriseOid,
                genericTrapType,
                specificTrapType,
                variables);

            OnTrapReceived?.Invoke(this, trapEvent);
        }
        catch (Exception ex)
        {
            // 파싱 오류 시 에러 TrapEvent 발생
            OnTrapReceived?.Invoke(this, new TrapEvent(
                remoteEndPoint.Address.ToString(),
                remoteEndPoint.Port,
                SnmpVersion.V2c,
                errorMessage: $"Trap parse error: {ex.Message}"));
        }
    }
}
```

---

### 4. UI 레이어: 연동

#### 4.1 `MainWindow.xaml.cs` 수정

**수정 사항**:

1. **필드 추가** (약 32번째 줄):
```csharp
private readonly ISnmpClient _snmpClient;
private readonly IMibService _mibService;
private readonly IPollingService _pollingService;
private readonly ITrapListener _trapListener;  // 추가
private readonly MainViewModel _vm;
```

2. **생성자에서 초기화** (약 47번째 줄):
```csharp
_snmpClient = new SnmpClient();
_mibService = new MibService();
_pollingService = new PollingService(_snmpClient);
_trapListener = new TrapListener();  // 추가
_vm = new MainViewModel();
DataContext = _vm;

// Polling 이벤트 연결
_pollingService.OnPollingResult += PollingService_OnPollingResult;

// Trap 이벤트 연결 (추가)
_trapListener.OnTrapReceived += TrapListener_OnTrapReceived;

// Trap Listener 시작 (추가)
InitializeTrapListener();
```

3. **TrapListener 초기화 메서드 추가**:
```csharp
private void InitializeTrapListener()
{
    try
    {
        _trapListener.Start(162);
        _vm.AddEvent(EventSeverity.Info, null, 
            "[System] Trap Listener started on port 162");
    }
    catch (Exception ex)
    {
        _vm.AddEvent(EventSeverity.Error, null, 
            $"[System] Failed to start Trap Listener: {ex.Message}");
    }
}
```

4. **Trap 수신 이벤트 핸들러 추가**:
```csharp
private void TrapListener_OnTrapReceived(object? sender, TrapEvent e)
{
    // 에러 처리
    if (e.ErrorMessage != null)
    {
        _vm.AddEvent(EventSeverity.Error, e.SourceIpAddress, 
            $"[Trap] {e.ErrorMessage}");
        return;
    }

    // Trap 기본 정보 구성
    var trapInfo = $"Trap from {e.SourceIpAddress}:{e.SourcePort}";
    if (!string.IsNullOrEmpty(e.EnterpriseOid))
    {
        trapInfo += $" Enterprise: {e.EnterpriseOid}";
    }
    if (!string.IsNullOrEmpty(e.GenericTrapType))
    {
        trapInfo += $" Generic: {e.GenericTrapType}";
    }
    if (e.Variables.Count > 0)
    {
        trapInfo += $" ({e.Variables.Count} variables)";
    }

    // Event Log에 기록
    _vm.AddEvent(EventSeverity.Info, e.SourceIpAddress, 
        $"[Trap] {trapInfo}");
    
    // 변수들도 로그에 기록 (최대 5개만, MIB 이름 변환 포함)
    foreach (var variable in e.Variables.Take(5))
    {
        var oidName = _mibService?.GetOidName(variable.Oid) ?? variable.Oid;
        _vm.AddEvent(EventSeverity.Info, e.SourceIpAddress, 
            $"  {oidName} = {variable.Value}");
    }
}
```

5. **Window 닫을 때 정리** (파일 끝에 추가):
```csharp
protected override void OnClosed(EventArgs e)
{
    _trapListener?.Stop();
    _pollingService?.Stop();
    base.OnClosed(e);
}
```

---

## 구현 단계

### Phase 1: Core 레이어 구현 ✅

1. **ITrapListener 인터페이스 생성**
   - `SnmpNms.Core/Interfaces/ITrapListener.cs`
   - Start/Stop 메서드, IsListening 속성, OnTrapReceived 이벤트

2. **TrapEvent 모델 생성**
   - `SnmpNms.Core/Models/TrapEvent.cs`
   - Trap 정보를 담는 모델 클래스

### Phase 2: Infrastructure 레이어 구현 ✅

3. **TrapListener 구현체 생성**
   - `SnmpNms.Infrastructure/TrapListener.cs`
   - UDP 소켓 리스닝
   - SharpSnmpLib로 Trap 파싱
   - TrapEvent 생성 및 이벤트 발생

### Phase 3: UI 레이어 연동 ✅

4. **MainWindow에 TrapListener 통합**
   - 필드 추가
   - 초기화 및 이벤트 연결
   - Trap 수신 시 Event Log에 기록
   - MIB 이름 변환 연동

### Phase 4: 테스트 및 검증

5. **기능 테스트**
   - Trap 수신 확인
   - Event Log 기록 확인
   - MIB 이름 변환 확인
   - 에러 처리 확인

---

## 주의사항

### 포트 권한

- **UDP 포트 162**: 관리자 권한이 필요할 수 있음
- Windows에서 1024 이하 포트는 관리자 권한 필요
- 테스트 시 관리자 권한으로 실행하거나, 다른 포트(예: 1162) 사용 고려

### 에러 처리

- UDP 소켓 바인딩 실패: `SocketException` 처리
- Trap 파싱 실패: 에러 TrapEvent로 전달
- 네트워크 오류: 리스닝 루프에서 예외 처리 후 계속 실행

### 성능 고려사항

- 비동기 처리: `async/await` 사용
- 이벤트 핸들러: UI 스레드에서 실행되도록 Dispatcher 사용 고려
- 대량 Trap 처리: 큐잉 메커니즘 고려 (향후 확장)

---

## 향후 확장 계획

### 1. Trap 필터링

- 특정 OID만 수신
- 특정 IP 주소만 수신
- 커뮤니티 기반 필터링

### 2. Trap 저장소

- 데이터베이스 저장
- 파일 로그 저장
- Trap 히스토리 조회

### 3. Trap 알람 연동

- Severity 기반 알람 생성
- 중복 Trap 처리 (Dedup)
- 알람 확인/해제 (Ack/Clear)

### 4. SNMPv3 지원

- 인증 및 암호화
- USM (User-based Security Model) 지원

### 5. Inform 처리

- Inform 요청에 대한 응답 (ACK)
- Inform 타임아웃 처리

---

## 참고 자료

- **SNMP Trap RFC**: RFC 1157 (SNMPv1), RFC 3416 (SNMPv2c)
- **SharpSnmpLib 문서**: https://sharpsnmplib.codeplex.com/
- **기존 구현 참고**: `PollingService.cs` (유사한 엔진 패턴)

---

**작성일**: 2025-12-26  
**상태**: 계획 완료, 구현 대기  
**다음 단계**: Phase 1부터 순차적으로 구현

---

## 구현 완료 기록

**구현 완료일**: 2025-12-26  
**상태**: ✅ 구현 완료

### 구현 단계별 진행 내역

#### Phase 1: Core 레이어 구현 ✅

**1. ITrapListener 인터페이스 생성**
- 파일: `SnmpNms.Core/Interfaces/ITrapListener.cs`
- 내용:
  - `IsListening` 속성: 현재 리스닝 상태 확인
  - `Start(int port = 162)`: Trap 수신 시작
  - `Stop()`: Trap 수신 중지
  - `OnTrapReceived` 이벤트: Trap 수신 시 발생

**2. TrapEvent 모델 생성**
- 파일: `SnmpNms.Core/Models/TrapEvent.cs`
- 내용:
  - Trap 정보를 담는 모델 클래스
  - SourceIpAddress, SourcePort, Version, Community 등 필드
  - EnterpriseOid, GenericTrapType, SpecificTrapType (SNMPv1용)
  - Variables 리스트 (VarBind)
  - ErrorMessage (파싱 오류 시)

#### Phase 2: Infrastructure 레이어 구현 ✅

**3. TrapListener 구현체 생성**
- 파일: `SnmpNms.Infrastructure/TrapListener.cs`
- 구현 내용:
  - `UdpClient`를 사용한 UDP 소켓 리스닝
  - `CancellationTokenSource`로 비동기 작업 제어
  - `Task.Run`으로 백그라운드 리스닝 루프
  - `MessageFactory.ParseMessages()`로 SNMP 메시지 파싱
  - SNMPv1 Trap (`TrapV1Pdu`) 처리
  - SNMPv2c Trap (`TrapV2Pdu`) 처리
  - Inform (`InformRequestPdu`) 처리
  - 에러 처리 및 에러 TrapEvent 생성

**구현 중 이슈 및 해결**:
- 초기 시도: `MessageFactory.ParseMessage()` 사용 → API 없음
- 두 번째 시도: `Listener` 클래스 사용 → 클래스 없음
- 최종 해결: `UdpClient` 직접 사용 + `MessageFactory.ParseMessages()` 사용
- API 차이: `message.VersionCode` → `message.Version`으로 수정
- Null 처리: `ParseMessages`의 세 번째 파라미터에 `null!` 사용

#### Phase 3: UI 레이어 연동 ✅

**4. MainWindow.xaml.cs 수정**
- 파일: `SnmpNms.UI/MainWindow.xaml.cs`
- 수정 내용:
  1. 필드 추가: `private readonly ITrapListener _trapListener;`
  2. 생성자에서 초기화:
     - `_trapListener = new TrapListener();`
     - `_trapListener.OnTrapReceived += TrapListener_OnTrapReceived;`
     - `InitializeTrapListener();` 호출
  3. `InitializeTrapListener()` 메서드 추가:
     - 포트 162에서 Trap Listener 시작
     - 시작 성공/실패 시 Event Log에 기록
  4. `TrapListener_OnTrapReceived()` 이벤트 핸들러 추가:
     - Trap 기본 정보 구성 (IP, 포트, Enterprise OID, Generic Trap Type 등)
     - Event Log에 Trap 정보 기록
     - Trap 변수들도 로그에 기록 (최대 5개, MIB 이름 변환 포함)
  5. `OnClosed()` 메서드 추가:
     - Window 닫을 때 TrapListener와 PollingService 정리

### 생성/수정된 파일 목록

1. ✅ `SnmpNms.Core/Interfaces/ITrapListener.cs` (신규 생성)
2. ✅ `SnmpNms.Core/Models/TrapEvent.cs` (신규 생성)
3. ✅ `SnmpNms.Infrastructure/TrapListener.cs` (신규 생성)
4. ✅ `SnmpNms.UI/MainWindow.xaml.cs` (수정)

### 빌드 결과

- ✅ 빌드 성공 (경고 0개, 오류 0개)
- ✅ 모든 프로젝트 정상 컴파일

### 구현된 기능

- ✅ UDP 포트 162에서 SNMP Trap 수신
- ✅ SNMP v1 Trap 파싱 및 처리
- ✅ SNMP v2c Trap 파싱 및 처리
- ✅ Inform 메시지 처리 (기본 지원)
- ✅ Trap 정보를 Event Log에 자동 기록
- ✅ MIB 이름 변환 연동 (OID → 이름)
- ✅ 에러 처리 및 에러 로깅
- ✅ Start/Stop 제어
- ✅ 애플리케이션 종료 시 자동 정리

### 테스트 필요 사항

1. **포트 권한 확인**
   - UDP 포트 162는 관리자 권한이 필요할 수 있음
   - 테스트 시 관리자 권한으로 실행하거나 다른 포트(예: 1162) 사용 고려

2. **실제 Trap 수신 테스트**
   - SNMP 장비에서 Trap 전송
   - Event Log에 Trap 정보 표시 확인
   - MIB 이름 변환 확인

3. **에러 처리 확인**
   - 잘못된 형식의 Trap 수신 시 에러 처리 확인
   - 네트워크 오류 시 리스닝 루프 지속 확인

### 향후 개선 사항

1. **Trap 필터링**
   - 특정 OID만 수신
   - 특정 IP 주소만 수신
   - 커뮤니티 기반 필터링

2. **Trap 저장소**
   - 데이터베이스 저장
   - 파일 로그 저장
   - Trap 히스토리 조회

3. **Trap 알람 연동**
   - Severity 기반 알람 생성
   - 중복 Trap 처리 (Dedup)
   - 알람 확인/해제 (Ack/Clear)

4. **SNMPv3 지원**
   - 인증 및 암호화
   - USM (User-based Security Model) 지원

5. **Inform 응답**
   - Inform 요청에 대한 ACK 응답
   - Inform 타임아웃 처리

---

**최종 수정일**: 2025-12-26  
**구현 상태**: ✅ 완료  
**빌드 상태**: ✅ 성공

---

## Trap Test 기능 추가 (2025-12-26)

### 목적

TrapListener를 테스트하기 위한 UI 기능 추가. SNMP Test 탭에서 직접 Trap을 전송하고 수신할 수 있도록 구현.

### 구현 내용

#### 1. UI 추가 (MainWindow.xaml)

**SNMP Test 탭에 Trap Test 섹션 추가**:
- **Trap Target**: Trap 수신 대상 IP 주소 입력 필드 (기본값: `127.0.0.1`)
- **Trap Port**: Trap 수신 포트 입력 필드 (기본값: `162`)
- **Trap OID**: 전송할 Trap OID 입력 필드 (기본값: `1.3.6.1.4.1.1.1.1.1`)
- **Send Trap 버튼**: SNMPv2c Trap 전송 버튼

**레이아웃 구조**:
```
SNMP Test 탭
├─ SNMP GET 테스트 (기존)
│  ├─ IP Address
│  ├─ Community
│  ├─ OID/Name
│  └─ Get 버튼
│
└─ Trap Test (신규 추가)
   ├─ Trap Target (IP)
   ├─ Trap Port
   ├─ Trap OID
   └─ Send Trap 버튼
```

#### 2. 코드 구현 (MainWindow.xaml.cs)

**추가된 using 문**:
```csharp
using System.Net;
using Lextm.SharpSnmpLib;
using Lextm.SharpSnmpLib.Messaging;
using VersionCode = Lextm.SharpSnmpLib.VersionCode;
```

**BtnSendTrap_Click() 메서드 구현**:
- 입력 검증 (IP 주소, 포트, OID)
- MIB 이름 → OID 변환 지원
- SNMPv2c Trap 전송 (`Messenger.SendTrapV2`)
- Event Log에 전송 결과 기록

**주요 기능**:
1. **입력 검증**:
   - Trap Target IP 주소 필수 입력 확인
   - 포트 번호 유효성 검사 (1-65535)
   - Trap OID 필수 입력 확인

2. **MIB 이름 변환**:
   - OID가 숫자로 시작하지 않으면 MIB 이름으로 간주
   - `_mibService.GetOid()`로 OID로 변환
   - 변환 결과를 Event Log에 기록

3. **Trap 전송**:
   - SNMPv2c Trap 전송
   - sysUpTime (1.3.6.1.2.1.1.3.0)과 Trap OID를 포함한 변수 전송
   - 타임스탬프 포함 메시지

4. **에러 처리**:
   - IP 주소 파싱 오류 처리
   - Trap 전송 실패 시 에러 메시지 표시

### 사용 방법

1. **애플리케이션 실행**
   - TrapListener가 포트 162에서 자동 시작
   - Event Log에 "[System] Trap Listener started on port 162" 확인

2. **SNMP Test 탭 이동**

3. **Trap Test 섹션에서**:
   - Trap Target: `127.0.0.1` (로컬 테스트)
   - Trap Port: `162` (또는 TrapListener가 시작한 포트)
   - Trap OID: 원하는 OID 입력 (예: `1.3.6.1.4.1.1.1.1.1`)

4. **Send Trap 버튼 클릭**

5. **Event Log 확인**:
   - `[Trap Test] Sending SNMPv2c Trap to 127.0.0.1:162...`
   - `[Trap Test] Trap sent successfully! OID: ...`
   - `[Trap] Trap from 127.0.0.1:...` (TrapListener가 수신)

### 테스트 시나리오

**로컬 테스트 (127.0.0.1)**:
- 같은 애플리케이션에서 Trap 전송/수신
- TrapListener가 수신한 Trap을 Event Log에서 확인

**원격 테스트**:
- 다른 PC의 IP 주소 입력
- 해당 PC에서 TrapListener가 실행 중이어야 함

**포트 변경 테스트**:
- 개발 시 포트 1162 사용 권장 (162는 관리자 권한 필요)
- TrapListener와 Trap 전송 모두 같은 포트 사용

### 구현 파일

1. **SnmpNms.UI/MainWindow.xaml**
   - Trap Test UI 추가 (Trap Target, Trap Port, Trap OID, Send Trap 버튼)

2. **SnmpNms.UI/MainWindow.xaml.cs**
   - `BtnSendTrap_Click()` 메서드 추가
   - SharpSnmpLib using 문 추가

### 빌드 결과

- ✅ 빌드 성공 (경고 0개, 오류 0개)
- ✅ 모든 기능 정상 동작

### 장점

1. **통합된 테스트 환경**: SNMP GET과 Trap 전송을 같은 탭에서 테스트 가능
2. **직관적인 UI**: 간단한 입력 필드와 버튼으로 쉽게 사용 가능
3. **실시간 피드백**: Event Log에서 전송/수신 결과를 즉시 확인
4. **MIB 이름 지원**: OID 대신 MIB 이름으로도 입력 가능

### 향후 개선 사항

1. **SNMPv1 Trap 지원**: 현재는 SNMPv2c만 지원, v1 추가 고려
2. **Trap 변수 편집**: 여러 변수를 추가/편집할 수 있는 UI
3. **Trap 템플릿**: 자주 사용하는 Trap을 템플릿으로 저장
4. **전송 이력**: 전송한 Trap 목록 표시

---

**Trap Test 기능 추가일**: 2025-12-26  
**상태**: ✅ 완료  
**빌드 상태**: ✅ 성공

---

## Trap 설정 기능 구현 계획 (2025-12-26)

### 목적

실제 SNMP 장비에서 Trap을 받으려면 장비에 Trap 수신 대상(Trap Listener의 IP/Port)을 설정해야 합니다. 이를 위해 SNMP SET 기능과 Trap 설정 UI를 추가합니다.

### 현재 문제점

1. **SNMP SET 기능 없음**: `ISnmpClient`에 `SetAsync` 메서드가 없음
2. **Trap 설정 UI 없음**: `MapObjectPropertiesDialog`에 Trap 설정 UI가 없음
3. **Discovery 시 Trap 설정 안 함**: Discovery 완료 후 Trap 설정을 하지 않음
4. **Trap Listener 정보 접근 불가**: Trap Listener의 IP/Port 정보를 가져오는 방법이 없음

### 구현 계획

#### Phase 1: SNMP SET 기능 추가 ✅

**1. Core 인터페이스 확장**
- 파일: `SnmpNms.Core/Interfaces/ISnmpClient.cs`
- 추가: `SetAsync(ISnmpTarget target, string oid, string value, string type)` 메서드

**2. Infrastructure 구현**
- 파일: `SnmpNms.Infrastructure/SnmpClient.cs`
- 구현: `Messenger.Set()` 사용하여 SNMP SET 요청 전송

#### Phase 2: Trap Listener 정보 제공 ✅

**3. Trap Listener 인터페이스 확장**
- 파일: `SnmpNms.Core/Interfaces/ITrapListener.cs`
- 추가: `GetListenerInfo()` 메서드 (IP 주소, 포트 반환)

**4. Trap Listener 구현 확장**
- 파일: `SnmpNms.Infrastructure/TrapListener.cs`
- 구현: 로컬 IP 주소와 포트 정보 반환

#### Phase 3: Trap 설정 UI 추가 ✅

**5. MapObjectPropertiesDialog UI 확장**
- 파일: `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml`
- Access 탭에 Trap 설정 섹션 추가:
  - Trap Destination IP 입력 필드
  - Trap Destination Port 입력 필드
  - "Configure Trap Destination" 버튼

**6. MapObjectPropertiesDialog 로직 추가**
- 파일: `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml.cs`
- Trap 설정 버튼 클릭 핸들러 추가
- SNMP SET로 Trap Destination 설정

#### Phase 4: Discovery 시 Trap 설정 옵션 ✅

**7. Discovery 다이얼로그 확장**
- 파일: `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml(.cs)`
- Discovery 완료 후 "Configure Trap Destination?" 체크박스 추가
- 선택한 장비에 자동으로 Trap 설정

### 구현 세부사항

#### SNMP SET 구현

**표준 SNMP MIB OID (시도할 OID들)**:
- `1.3.6.1.6.3.18.1.3.0` (snmpTrapAddress) - 표준이지만 모든 장비에서 지원하지 않음
- Vendor별 OID:
  - MVD5000/MVE5000: `mvd5000SnmpTrapDstTable` (테이블 형태)
  - Cisco: CLI 명령 필요 (`snmp-server host`)
  - 기타: 장비별로 다름

**구현 전략**:
1. 표준 OID 시도
2. 실패 시 사용자에게 알림
3. Vendor별 OID는 향후 확장

#### Trap Listener 정보 가져오기

**로컬 IP 주소 가져오기**:
```csharp
// 로컬 IP 주소 찾기
var localIP = Dns.GetHostEntry(Dns.GetHostName())
    .AddressList
    .FirstOrDefault(ip => ip.AddressFamily == AddressFamily.InterNetwork)
    ?.ToString() ?? "127.0.0.1";
```

**포트 정보**:
- Trap Listener가 시작한 포트 (기본 162)

#### Trap 설정 UI 흐름

1. **MapObjectPropertiesDialog 열기**
   - Access 탭 → Trap 설정 섹션
   - Trap Destination IP/Port 입력 필드 (기본값: Trap Listener IP/Port)

2. **"Configure Trap Destination" 버튼 클릭**
   - SNMP SET 요청 전송
   - 성공/실패 메시지 표시

3. **Discovery 완료 후**
   - "Configure Trap Destination?" 체크박스
   - 선택 시 모든 선택된 장비에 Trap 설정

### 예상 구현 파일

1. `SnmpNms.Core/Interfaces/ISnmpClient.cs` (수정)
2. `SnmpNms.Infrastructure/SnmpClient.cs` (수정)
3. `SnmpNms.Core/Interfaces/ITrapListener.cs` (수정)
4. `SnmpNms.Infrastructure/TrapListener.cs` (수정)
5. `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml` (수정)
6. `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml.cs` (수정)
7. `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml` (수정)
8. `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml.cs` (수정)

### 주의사항

1. **SNMP SET 권한**: Write Community가 필요함
2. **Vendor별 차이**: 장비마다 Trap 설정 방법이 다름
3. **표준 OID 한계**: 모든 장비에서 표준 OID를 지원하지 않음
4. **에러 처리**: SET 실패 시 사용자에게 명확한 메시지 제공

### 향후 확장

1. **Vendor별 Trap 설정**: MVD5000/MVE5000 등 특정 장비 지원
2. **Trap 설정 템플릿**: 자주 사용하는 Trap 설정 저장
3. **Trap 설정 확인**: GET으로 현재 설정 확인
4. **다중 Trap Destination**: 여러 Trap 수신 대상 설정

---

**계획 작성일**: 2025-12-26  
**상태**: ✅ 구현 완료  
**구현 완료일**: 2025-12-26

---

## Trap 설정 기능 구현 완료 (2025-12-26)

### 구현 완료 내용

#### Phase 1: SNMP SET 기능 추가 ✅

**1. Core 인터페이스 확장**
- 파일: `SnmpNms.Core/Interfaces/ISnmpClient.cs`
- 추가: `SetAsync(ISnmpTarget target, string oid, string value, string type)` 메서드

**2. Infrastructure 구현**
- 파일: `SnmpNms.Infrastructure/SnmpClient.cs`
- 구현: `Messenger.Set()` 사용하여 SNMP SET 요청 전송
- 지원 타입: INTEGER, OCTETSTRING, IPADDRESS, COUNTER32, COUNTER64, GAUGE32, TIMETICKS, OBJECTIDENTIFIER

#### Phase 2: Trap Listener 정보 제공 ✅

**3. Trap Listener 인터페이스 확장**
- 파일: `SnmpNms.Core/Interfaces/ITrapListener.cs`
- 추가: `GetListenerInfo()` 메서드 (IP 주소, 포트 반환)

**4. Trap Listener 구현 확장**
- 파일: `SnmpNms.Infrastructure/TrapListener.cs`
- 구현: 로컬 IP 주소와 포트 정보 반환
- 활성 네트워크 인터페이스에서 IPv4 주소 자동 감지

#### Phase 3: Trap 설정 UI 추가 ✅

**5. MapObjectPropertiesDialog UI 확장**
- 파일: `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml`
- Access 탭에 Trap 설정 섹션 추가:
  - Trap Destination IP 입력 필드
  - Trap Destination Port 입력 필드
  - "Configure Trap" 버튼
  - 사용 안내 메시지

**6. MapObjectPropertiesDialog 로직 추가**
- 파일: `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml.cs`
- Trap 설정 버튼 클릭 핸들러 추가
- SNMP SET로 Trap Destination 설정 (표준 OID: 1.3.6.1.6.3.18.1.3.0)
- 성공/실패 메시지 표시
- Trap Listener 정보로 기본값 자동 설정

#### Phase 4: Discovery 시 Trap 설정 옵션 ✅

**7. Discovery 다이얼로그 확장**
- 파일: `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml(.cs)`
- Discovery 완료 후 "Configure Trap Destination for selected devices" 체크박스 추가
- OK 버튼 클릭 시 선택된 장비에 자동으로 Trap 설정
- Trap Listener가 실행 중이 아니면 체크박스 비활성화

**8. MainWindow 연동**
- 파일: `SnmpNms.UI/MainWindow.xaml.cs`
- `MapObjectPropertiesDialog` 생성 시 `_trapListener` 전달
- `DiscoveryPollingAgentsDialog` 생성 시 `_trapListener` 전달

### 구현 세부사항

#### SNMP SET 구현

**표준 SNMP MIB OID**:
- `1.3.6.1.6.3.18.1.3.0` (snmpTrapAddress) - 표준이지만 모든 장비에서 지원하지 않음

**구현 전략**:
1. 표준 OID 시도
2. 실패 시 사용자에게 알림 (장비가 표준 OID를 지원하지 않거나 Write Community가 잘못됨)
3. Vendor별 OID는 향후 확장 예정

#### Trap Listener 정보 가져오기

**로컬 IP 주소 가져오기**:
- 활성 네트워크 인터페이스에서 IPv4 주소 자동 감지
- Loopback 인터페이스 제외
- 실패 시 기본값 "127.0.0.1" 사용

**포트 정보**:
- Trap Listener가 시작한 포트 (기본 162)

#### Trap 설정 UI 흐름

1. **MapObjectPropertiesDialog 열기**
   - Access 탭 → Trap 설정 섹션
   - Trap Destination IP/Port 입력 필드 (기본값: Trap Listener IP/Port)

2. **"Configure Trap" 버튼 클릭**
   - 입력값 검증 (IP 주소, 포트 범위)
   - SNMP SET 요청 전송 (Write Community 사용)
   - 성공/실패 메시지 표시

3. **Discovery 완료 후**
   - "Configure Trap Destination for selected devices" 체크박스
   - 선택 시 모든 선택된 장비에 Trap 설정
   - 성공/실패 개수 표시

### 구현된 파일

1. ✅ `SnmpNms.Core/Interfaces/ISnmpClient.cs` (수정)
2. ✅ `SnmpNms.Infrastructure/SnmpClient.cs` (수정)
3. ✅ `SnmpNms.Core/Interfaces/ITrapListener.cs` (수정)
4. ✅ `SnmpNms.Infrastructure/TrapListener.cs` (수정)
5. ✅ `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml` (수정)
6. ✅ `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml.cs` (수정)
7. ✅ `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml` (수정)
8. ✅ `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml.cs` (수정)
9. ✅ `SnmpNms.UI/Views/Dialogs/DiscoveryPollingAgentsDialog.xaml.cs` (수정)
10. ✅ `SnmpNms.UI/MainWindow.xaml.cs` (수정)

### 주의사항

1. **SNMP SET 권한**: Write Community가 필요함
2. **Vendor별 차이**: 장비마다 Trap 설정 방법이 다름
3. **표준 OID 한계**: 모든 장비에서 표준 OID를 지원하지 않음
4. **에러 처리**: SET 실패 시 사용자에게 명확한 메시지 제공

### 향후 확장

1. **Vendor별 Trap 설정**: MVD5000/MVE5000 등 특정 장비 지원
2. **Trap 설정 템플릿**: 자주 사용하는 Trap 설정 저장
3. **Trap 설정 확인**: GET으로 현재 설정 확인
4. **다중 Trap Destination**: 여러 Trap 수신 대상 설정

---

**구현 완료일**: 2025-12-26  
**빌드 상태**: ✅ 성공 (경고 0개, 오류 0개)

---

## Trap 설정 기능 개선 (2025-12-26)

### 개선 내용

Discovery 완료 후 여러 기기를 등록할 때 Trap 설정을 일괄 처리하도록 개선했습니다.

#### 변경 전 문제점

- Discovery 완료 후 `DiscoveryProgressDialog`에서 OK 버튼 클릭 시 Trap 설정 수행
- Map 등록과 Trap 설정이 분리되어 있어 사용자 경험이 불편함
- Trap 설정 실패 시에도 Map 등록은 진행되어 일관성 부족

#### 변경 후 개선사항

1. **일괄 처리 흐름 개선**
   - `DiscoveryProgressDialog`: Trap 설정을 수행하지 않고 `ConfigureTrapDestination` 플래그만 유지
   - `DiscoveryPollingAgentsDialog`: Map 등록 전에 선택된 모든 기기에 Trap 설정을 일괄 수행
   - Trap 설정 → Map 등록 순서로 진행하여 일관성 확보

2. **사용자 경험 개선**
   - Discovery 완료 후 "Configure Trap Destination for selected devices" 체크박스 선택
   - OK 클릭 시 자동으로 Trap 설정 수행 후 Map 등록
   - 완료 메시지에 "(Trap configured)" 표시로 설정 상태 확인 가능

3. **에러 처리 개선**
   - Trap 설정 성공/실패 개수를 메시지 박스로 표시
   - 일부 기기 실패해도 나머지 기기는 정상적으로 Map에 등록

### 변경된 파일

1. ✅ `SnmpNms.UI/Views/Dialogs/DiscoveryProgressDialog.xaml.cs` (수정)
   - `BtnOk_Click`: Trap 설정 로직 제거, 다이얼로그만 닫기
   - `ConfigureTrapForDevicesAsync`: 메서드 제거 (DiscoveryPollingAgentsDialog로 이동)

2. ✅ `SnmpNms.UI/Views/Dialogs/DiscoveryPollingAgentsDialog.xaml.cs` (수정)
   - `BtnRestart_Click`: `async`로 변경
   - `ConfigureTrapForDevicesAsync`: 새로 추가, 선택된 기기들에 Trap 설정 일괄 수행
   - Map 등록 전에 Trap 설정 수행하도록 순서 변경

### 개선된 동작 흐름

```
1. Discovery 실행
   ↓
2. 기기 발견 및 선택
   ↓
3. "Configure Trap Destination for selected devices" 체크박스 선택
   ↓
4. OK 버튼 클릭
   ↓
5. 선택된 모든 기기에 Trap 설정 일괄 수행 (성공/실패 개수 표시)
   ↓
6. Map에 기기 등록
   ↓
7. 완료 메시지 표시 ("Added X device(s) to map (Trap configured)")
```

### 코드 변경 사항

#### DiscoveryProgressDialog.xaml.cs

**변경 전**:
```csharp
private async void BtnOk_Click(object sender, RoutedEventArgs e)
{
    // Trap 설정이 활성화되어 있으면 Trap 설정 수행
    if (ConfigureTrapDestination && _trapListener != null && _trapListener.IsListening)
    {
        // ... Trap 설정 로직 ...
        await ConfigureTrapForDevicesAsync(selectedDevices, trapIp, trapPort);
    }
    
    DialogResult = true;
    Close();
}
```

**변경 후**:
```csharp
private void BtnOk_Click(object sender, RoutedEventArgs e)
{
    // Trap 설정은 DiscoveryPollingAgentsDialog에서 Map 등록 시 함께 수행
    // 여기서는 다이얼로그만 닫고 ConfigureTrapDestination 플래그는 유지
    DialogResult = true;
    Close();
}
```

#### DiscoveryPollingAgentsDialog.xaml.cs

**추가된 메서드**:
```csharp
private async Task ConfigureTrapForDevicesAsync(
    List<DiscoveryProgressDialog.DiscoveredDevice> devices, 
    string trapIp, 
    int trapPort)
{
    // 선택된 모든 기기에 Trap 설정 일괄 수행
    // 성공/실패 개수를 메시지 박스로 표시
}
```

**변경된 BtnRestart_Click**:
```csharp
private async void BtnRestart_Click(object sender, RoutedEventArgs e)
{
    // ... Discovery 실행 ...
    
    if (progressDialog.ShowDialog() == true)
    {
        var selectedDevices = progressDialog.DiscoveredDevices
            .Where(d => d.IsSelected && d.Status != "Ping Only").ToList();
        
        // Trap 설정이 활성화되어 있으면 Map 등록 전에 Trap 설정 수행
        bool configureTrap = progressDialog.ConfigureTrapDestination && 
                             _trapListener != null && 
                             _trapListener.IsListening;
        
        if (configureTrap && selectedDevices.Count > 0 && _trapListener != null)
        {
            var (trapIp, trapPort) = _trapListener.GetListenerInfo();
            await ConfigureTrapForDevicesAsync(selectedDevices, trapIp, trapPort);
        }
        
        // Map에 기기 등록
        foreach (var device in selectedDevices)
        {
            // ... Map 등록 로직 ...
        }
        
        // 완료 메시지
        var trapInfo = configureTrap ? " (Trap configured)" : "";
        MessageBox.Show($"Added {selectedDevices.Count} device(s) to map{trapInfo}.", ...);
    }
}
```

### 장점

1. **일관성**: Trap 설정과 Map 등록이 하나의 흐름으로 통합
2. **편의성**: 여러 기기를 한 번에 처리하여 사용자 작업 감소
3. **명확성**: 완료 메시지로 Trap 설정 상태 확인 가능
4. **안정성**: Trap 설정 실패해도 Map 등록은 정상 진행

---

**개선 완료일**: 2025-12-26  
**빌드 상태**: ✅ 성공

---

## Trap Destination IP 주소 개선 (2025-12-26)

### 문제점

기존 구현에서 Trap Destination IP가 `127.0.0.1` (localhost)로 기본 설정되어 있었습니다. 이로 인해 다른 서브넷의 기기들이 Trap을 전송할 때 자기 자신(127.0.0.1)으로 보내게 되어 NMS 서버에 도달하지 못하는 문제가 발생했습니다.

### 개선 내용

Trap Destination이 항상 실제 네트워크 IP 주소를 사용하도록 개선했습니다.

#### 1. ITrapListener 인터페이스 확장

**파일**: `SnmpNms.Core/Interfaces/ITrapListener.cs`

- `GetLocalNetworkIp()` 메서드 추가
  - 실제 네트워크 IP 주소를 반환하는 메서드
  - Loopback(127.0.0.1) 제외

#### 2. TrapListener 구현 개선

**파일**: `SnmpNms.Infrastructure/TrapListener.cs`

**변경 사항**:
- `GetListenerInfo()`: Trap Listener가 실행되지 않아도 실제 IP 주소 반환
  - 기존: `("0.0.0.0", 0)` 반환
  - 변경: `(GetLocalNetworkIp(), 162)` 반환

- `GetLocalNetworkIp()` 구현:
  ```csharp
  public string GetLocalNetworkIp()
  {
      // 활성 네트워크 인터페이스에서 IPv4 주소 찾기
      // 우선순위: Ethernet > Wireless > 기타
      var networkInterfaces = NetworkInterface.GetAllNetworkInterfaces()
          .Where(ni => ni.OperationalStatus == OperationalStatus.Up &&
                      ni.NetworkInterfaceType != NetworkInterfaceType.Loopback)
          .OrderByDescending(ni => ni.NetworkInterfaceType == NetworkInterfaceType.Ethernet)
          .ThenByDescending(ni => ni.NetworkInterfaceType == NetworkInterfaceType.Wireless80211);
      
      // 첫 번째 유효한 IP 주소 반환
      // 실패 시 127.0.0.1 반환
  }
  ```

**IP 주소 선택 우선순위**:
1. Ethernet 인터페이스
2. Wireless 인터페이스
3. 기타 활성 인터페이스
4. 모두 실패 시: `127.0.0.1` (경고 표시 권장)

#### 3. MapObjectPropertiesDialog 개선

**파일**: `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml.cs`

**변경 사항**:
- Trap Listener가 없어도 실제 네트워크 IP 주소 사용
- `GetLocalNetworkIp()` 메서드 추가 (Trap Listener가 없을 때 사용)

**이전 코드**:
```csharp
if (_trapListener != null && _trapListener.IsListening)
{
    var (ip, port) = _trapListener.GetListenerInfo();
    TrapDestinationIp = ip;
    TrapDestinationPort = port.ToString();
}
else
{
    TrapDestinationIp = "127.0.0.1";  // 문제: 다른 서브넷에서 접근 불가
    TrapDestinationPort = "162";
}
```

**변경 후 코드**:
```csharp
if (_trapListener != null)
{
    var (ip, port) = _trapListener.GetListenerInfo();
    TrapDestinationIp = ip;  // 항상 실제 네트워크 IP
    TrapDestinationPort = port.ToString();
}
else
{
    TrapDestinationIp = GetLocalNetworkIp();  // 실제 네트워크 IP 자동 감지
    TrapDestinationPort = "162";
}
```

### 개선 효과

#### 이전 동작
- Trap Listener 실행 중: 실제 IP 주소 사용 ✅
- Trap Listener 미실행: `127.0.0.1` 사용 ❌
  - 다른 서브넷의 기기들이 Trap을 보낼 수 없음
  - 로컬 호스트에서만 동작

#### 개선 후 동작
- Trap Listener 실행 중: 실제 IP 주소 사용 ✅
- Trap Listener 미실행: 실제 IP 주소 자동 감지 ✅
- 항상 실제 네트워크 IP 주소 사용
- 다른 서브넷의 기기들도 Trap 전송 가능

### 사용 시나리오

**시나리오 1: 같은 서브넷**
- NMS 서버: `192.168.1.100`
- 기기: `192.168.1.50`
- Trap Destination: `192.168.1.100` ✅

**시나리오 2: 다른 서브넷**
- NMS 서버: `192.168.1.100`
- 기기: `192.168.2.50`
- Trap Destination: `192.168.1.100` ✅ (이전에는 127.0.0.1로 설정되어 실패)

**시나리오 3: 여러 네트워크 인터페이스**
- Ethernet: `192.168.1.100`
- Wireless: `10.0.0.50`
- 선택: Ethernet 우선 → `192.168.1.100` ✅

### 변경된 파일

1. ✅ `SnmpNms.Core/Interfaces/ITrapListener.cs` (수정)
   - `GetLocalNetworkIp()` 메서드 추가

2. ✅ `SnmpNms.Infrastructure/TrapListener.cs` (수정)
   - `GetListenerInfo()` 개선
   - `GetLocalNetworkIp()` 구현

3. ✅ `SnmpNms.UI/Views/Dialogs/MapObjectPropertiesDialog.xaml.cs` (수정)
   - Trap Listener가 없어도 실제 IP 주소 사용
   - `GetLocalNetworkIp()` 메서드 추가
   - `System.Net.Sockets`, `System.Linq` 네임스페이스 추가

### 주의사항

1. **다중 네트워크 인터페이스**: 여러 인터페이스가 있을 경우 Ethernet을 우선 선택
2. **네트워크 인터페이스 없음**: 모든 인터페이스가 비활성화된 경우 `127.0.0.1` 반환 (경고 표시 권장)
3. **동적 IP 변경**: 네트워크 인터페이스가 변경되면 애플리케이션 재시작 시 새로운 IP 주소 감지

### 향후 개선 가능 사항

1. **사용자 선택**: 여러 네트워크 인터페이스가 있을 때 사용자가 선택할 수 있는 옵션
2. **IP 변경 감지**: 네트워크 인터페이스 변경 시 자동으로 IP 주소 업데이트
3. **설정 저장**: 사용자가 선택한 네트워크 인터페이스 설정 저장

---

**개선 완료일**: 2025-12-26  
**빌드 상태**: ✅ 성공 (경고 0개, 오류 0개)

---

## 테스트 방법

TrapListener를 테스트하는 여러 방법을 정리했습니다.

### 방법 1: Net-SNMP의 snmptrap 명령어 사용 (권장)

**Windows에서 Net-SNMP 설치**:
1. Net-SNMP 다운로드: http://www.net-snmp.org/download.html
2. 설치 후 명령 프롬프트에서 사용 가능

**기본 사용법**:
```bash
# SNMPv2c Trap 전송
snmptrap -v 2c -c public localhost:162 "" 1.3.6.1.4.1.1.1.1.1 1.3.6.1.4.1.1.1.1.1 s "Test Trap Message"

# SNMPv1 Trap 전송
snmptrap -v 1 -c public localhost:162 1.3.6.1.4.1.1.1.1.1 localhost 6 0 "" 1.3.6.1.4.1.1.1.1.1 s "Test Trap"
```

**명령어 파라미터 설명**:
- `-v 2c`: SNMP 버전 (1 또는 2c)
- `-c public`: 커뮤니티 문자열
- `localhost:162`: 수신 대상 (TrapListener가 실행 중인 IP:포트)
- 마지막 부분: OID와 값

**주의사항**:
- 포트 162는 관리자 권한 필요 → 다른 포트(예: 1162)로 테스트 권장
- TrapListener도 같은 포트로 시작해야 함

---

### 방법 2: C# 코드로 Trap 전송 테스트 프로그램 작성

**TrapSender.cs** (테스트용 콘솔 프로그램):

```csharp
using System;
using System.Net;
using Lextm.SharpSnmpLib;
using Lextm.SharpSnmpLib.Messaging;
using VersionCode = Lextm.SharpSnmpLib.VersionCode;

class TrapSender
{
    static void Main(string[] args)
    {
        var target = new IPEndPoint(IPAddress.Parse("127.0.0.1"), 162);
        var community = new OctetString("public");
        
        // SNMPv2c Trap 전송
        var trapOid = new ObjectIdentifier("1.3.6.1.4.1.1.1.1.1");
        var sysUpTime = new TimeTicks(0);
        var trapId = new ObjectIdentifier("1.3.6.1.4.1.1.1.1.1");
        
        var variables = new List<Variable>
        {
            new Variable(new ObjectIdentifier("1.3.6.1.2.1.1.3.0"), sysUpTime),
            new Variable(trapId, new OctetString("Test Trap Message"))
        };
        
        try
        {
            Messenger.SendTrapV2(
                0,
                VersionCode.V2,
                target,
                community,
                trapOid,
                variables);
            
            Console.WriteLine("Trap sent successfully!");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
}
```

**사용 방법**:
1. 별도 콘솔 프로젝트 생성
2. SharpSnmpLib NuGet 패키지 추가
3. 위 코드 복사 후 실행
4. TrapListener가 실행 중인 애플리케이션의 Event Log 확인

---

### 방법 3: 실제 SNMP 장비 사용

**네트워크 장비에서 Trap 전송**:
1. 라우터, 스위치 등 SNMP 지원 장비 설정
2. SNMP Trap 설정에서 Trap 수신 대상 설정:
   - IP: TrapListener 실행 중인 PC의 IP
   - Port: 162 (또는 설정한 포트)
   - Community: public (또는 설정한 커뮤니티)
3. 장비에서 이벤트 발생 시 Trap 자동 전송
4. Event Log에서 Trap 수신 확인

**일반적인 Trap 발생 이벤트**:
- 인터페이스 Up/Down
- 링크 상태 변경
- 온도/전력 임계값 초과
- 시스템 재시작

---

### 방법 4: 포트 변경하여 테스트 (권장)

**포트 162는 관리자 권한 필요**하므로, 개발/테스트 시 다른 포트 사용 권장:

**MainWindow.xaml.cs 수정**:
```csharp
private void InitializeTrapListener()
{
    try
    {
        // 개발/테스트용으로 포트 1162 사용
        _trapListener.Start(1162);
        _vm.AddEvent(EventSeverity.Info, null, "[System] Trap Listener started on port 1162");
    }
    catch (Exception ex)
    {
        _vm.AddEvent(EventSeverity.Error, null, $"[System] Failed to start Trap Listener: {ex.Message}");
    }
}
```

**snmptrap 명령어로 테스트**:
```bash
snmptrap -v 2c -c public localhost:1162 "" 1.3.6.1.4.1.1.1.1.1 1.3.6.1.4.1.1.1.1.1 s "Test Trap"
```

---

### 방법 5: 간단한 PowerShell 스크립트 (Windows)

**Send-Trap.ps1**:
```powershell
# Net-SNMP가 설치되어 있어야 함
$target = "localhost"
$port = 1162  # 또는 162 (관리자 권한 필요)
$community = "public"

# SNMPv2c Trap 전송
& snmptrap -v 2c -c $community "${target}:${port}" "" `
    1.3.6.1.4.1.1.1.1.1 `
    1.3.6.1.4.1.1.1.1.1 `
    s "PowerShell Test Trap"
```

**사용법**:
```powershell
.\Send-Trap.ps1
```

---

### 테스트 체크리스트

**기본 테스트**:
- [ ] TrapListener 시작 확인 (Event Log에 "[System] Trap Listener started" 메시지)
- [ ] Trap 수신 확인 (Event Log에 "[Trap] Trap from ..." 메시지)
- [ ] Trap 변수 확인 (Event Log에 OID와 값 표시)
- [ ] MIB 이름 변환 확인 (OID가 이름으로 변환되는지)

**에러 처리 테스트**:
- [ ] 잘못된 형식의 Trap 수신 시 에러 처리 확인
- [ ] 포트가 이미 사용 중일 때 에러 메시지 확인
- [ ] 네트워크 오류 시 리스닝 루프 지속 확인

**종료 테스트**:
- [ ] 애플리케이션 종료 시 TrapListener 정상 중지 확인

---

### 문제 해결

**포트 바인딩 실패**:
- **원인**: 포트 162는 관리자 권한 필요 또는 포트가 이미 사용 중
- **해결**: 관리자 권한으로 실행하거나 다른 포트(1162 등) 사용

**Trap 수신 안 됨**:
- **확인 사항**:
  1. TrapListener가 정상 시작되었는지 (Event Log 확인)
  2. 방화벽이 UDP 포트를 차단하지 않는지
  3. Trap 전송 대상 IP/포트가 올바른지
  4. 커뮤니티 문자열이 일치하는지

**MIB 이름 변환 안 됨**:
- **원인**: MIB 파일이 로드되지 않았거나 해당 OID가 MIB에 없음
- **해결**: MIB 파일 로드 확인, OID 확인

---

### 참고 자료

- **Net-SNMP 다운로드**: http://www.net-snmp.org/download.html
- **SNMP Trap RFC**: RFC 1157 (SNMPv1), RFC 3416 (SNMPv2c)
- **SharpSnmpLib 문서**: https://sharpsnmplib.codeplex.com/

