# MIB Database 작업 정리

이 문서는 **MIB Database(MIB 트리/테이블/표시)** 관련 구현 내용을 정리합니다.

---

## 1) 현재 구현된 기능

### 1.1 MIB 파일 로드

- **위치**: `SnmpNms.Infrastructure/MibService.cs`
- **기능**: MIB 파일(.mib, .txt) 파싱하여 OID ↔ Name 변환 제공
- **기본 MIB**: sysDescr, sysObjectID, sysUpTime 등 기본 표준 MIB 하드코딩
- **로드 경로**: `D:\git\snmpc\Mib` 또는 실행 파일 기준 `Mib` 폴더
- **호출 시점**: 애플리케이션 시작 시 `MainWindow` 생성자에서 `LoadMibs()` 호출

### 1.2 MIB 트리 모델

- **위치**: `SnmpNms.Core/Models/MibTreeNode.cs`
- **속성**:
  - `Name`: MIB 노드 이름
  - `Oid`: OID 문자열
  - `NodeType`: Folder/Table/Scalar/CustomTable (enum)
  - `Children`: ObservableCollection<MibTreeNode>
  - `IsExpanded`: 트리 확장 상태
  - `Description`: MIB 노드 설명 (선택적)
- **특징**: INotifyPropertyChanged 구현으로 UI 바인딩 지원

### 1.3 MIB 트리 구조 생성

- **인터페이스**: `IMibService.GetMibTree()` → `MibTreeNode` 반환
- **구현**: `MibService.GetMibTree()`
- **트리 구조**:
  - 루트: "Snmp Mibs"
    - `mgmt` (1.3.6.1.2.1) - 표준 MIB 서브트리
    - `Private` (1.3.6.1.4.1) - vendor-specific MIB 서브트리
    - `Custom-Tables` - 사용자 정의 테이블 (현재 비어있음)
- **트리 생성 로직**:
  - 로드된 OID를 파싱하여 계층 구조 생성
  - OID 세그먼트별로 중간 노드 생성
  - 마지막 세그먼트는 실제 MIB 이름 사용
  - 트리 노드는 이름 순으로 정렬

### 1.4 MIB 탭 UI

- **위치**: `SnmpNms.UI/MainWindow.xaml` (TabItem Header="Mib")
- **레이아웃**: 좌우 분할
  - **좌측**: MIB Selection Tree (TreeView, Width=300)
    - HierarchicalDataTemplate으로 계층 구조 표시
    - 노드 표시 형식: `Name (OID)`
    - 선택 시 상세 정보 패널 업데이트
  - **우측**: MIB 상세 정보 패널 (Width=400)
    - Name, OID, Type, Description 표시
    - Get/Get Next/Walk 버튼
- **초기화**: `MainWindow` 생성자에서 `InitializeMibTree()` 호출

### 1.5 Right-Click 메뉴

- **위치**: MIB TreeView의 ContextMenu
- **메뉴 항목**:
  - **Get**: 선택된 디바이스에 대해 선택된 MIB 노드의 OID로 SNMP GET 요청
  - **Get Next**: 선택된 디바이스에 대해 선택된 MIB 노드의 OID로 SNMP GET-NEXT 요청
  - **Walk**: 선택된 디바이스에 대해 선택된 MIB 노드의 OID로 SNMP WALK 요청
  - **Copy OID**: 선택된 MIB 노드의 OID를 클립보드에 복사
  - **Copy Name**: 선택된 MIB 노드의 이름을 클립보드에 복사
- **동작**: 선택된 디바이스가 없으면 경고 메시지 표시

### 1.6 SNMP 요청 실행

- **메서드**: `ExecuteSnmpGet()`, `ExecuteSnmpGetNext()`, `ExecuteSnmpWalk()`
- **동작**:
  - 선택된 디바이스(`_vm.SelectedDevice`)에 대해 SNMP 요청 실행
  - 결과를 Event Log에 표시
  - OID는 MIB 이름으로 변환하여 표시 (`_mibService.GetOidName()`)
  - Walk의 경우 처음 20개만 표시하고 나머지는 요약 표시

---

## 2) SNMPc 매뉴얼 요구사항 (미구현)

### 2.1 추가 Right-Click 메뉴 항목

- **View Table**: 선택된 디바이스의 MIB 테이블 표시 (미구현)
- **View Graph**: 선택된 디바이스의 MIB 테이블 그래프 표시 (미구현)
- **Insert Table...**: 사용자 정의 테이블 추가 (미구현)
- **Properties...**: MIB 노드 속성 표시 (미구현)

### 2.2 아이콘 구분

- 현재는 텍스트만 표시, 아이콘 미구현
- 목표:
  - 폴더 아이콘: 서브트리/폴더 (NodeType.Folder)
  - 테이블 그리드 아이콘: MIB 테이블 (NodeType.Table)
  - 스칼라 아이콘: 단일 값 (NodeType.Scalar)

---

## 3) 구현 세부사항

### 3.1 파일 구조

```
SnmpNms.Core/
  Models/
    MibTreeNode.cs          # MIB 트리 노드 모델
  Interfaces/
    IMibService.cs          # GetMibTree() 메서드 추가

SnmpNms.Infrastructure/
  MibService.cs            # GetMibTree() 구현, BuildTreeFromOids(), SortTree()

SnmpNms.UI/
  MainWindow.xaml          # MIB 탭 UI (TreeView + 상세 정보 패널)
  MainWindow.xaml.cs       # InitializeMibTree(), MIB 관련 이벤트 핸들러
```

### 3.2 MIB 트리 생성 알고리즘

1. 루트 노드 생성: "Snmp Mibs"
2. mgmt, Private, Custom-Tables 서브트리 노드 생성
3. `_oidToName` 딕셔너리를 순회하며:
   - OID가 `1.3.6.1.2.1`로 시작하면 mgmt 서브트리에 추가
   - OID가 `1.3.6.1.4.1`로 시작하면 Private 서브트리에 추가
   - OID를 세그먼트별로 분리하여 중간 노드 생성
   - 마지막 세그먼트는 실제 MIB 이름 사용
4. 각 서브트리의 자식 노드를 이름 순으로 정렬

### 3.3 MIB 파일 파서 (현재 상태)

- **방식**: 정규식 기반 단순 파서
- **패턴**: `([a-zA-Z0-9_-]+)\s+OBJECT-TYPE.*?::=\s*\{\s*([a-zA-Z0-9_-]+)\s+(\d+)\s*\}`
- **제한사항**:
  - 부모 OID를 알고 있는 경우에만 파싱 가능
  - SMIv2 문법의 일부만 지원
  - 테이블 자동 감지 미지원

---

## 4) 다음 작업(후속)

### 4.1 우선순위 높음

- **MIB 테이블 뷰 창**: `MibTableViewWindow.xaml` 구현
  - SNMP WALK을 사용하여 테이블 데이터 표시
  - DataGrid 형식 (행: 인스턴스, 열: 컬럼 OID)
- **MIB 노드 타입 자동 감지**: OBJECT-TYPE의 SYNTAX 분석하여 Table/Scalar 구분
- **아이콘 추가**: NodeType에 따라 폴더/테이블/스칼라 아이콘 표시

### 4.2 우선순위 중간

- **MIB 파일 파서 개선**: SMIv2 문법 지원 확대
- **MIB 그래프 뷰**: 시간에 따른 값 변화를 그래프로 표시
- **Custom Tables 관리**: 사용자 정의 테이블 추가/편집/삭제 기능
- **MIB 노드 검색**: 이름 또는 OID로 검색 기능

### 4.3 우선순위 낮음

- **MIB 노드 속성 다이얼로그**: 상세 정보 표시
- **MIB 파일 자동 다운로드**: 표준 MIB 파일 자동 다운로드 기능
- **MIB 컴파일 상태 표시**: 파싱 성공/실패 상태 표시

---

## 5) 참고 자료

- SNMPc Getting Started PDF: MIB Selection Tree 사용법
- SMIv2 (RFC 2578): MIB 파일 구조 정의
- SNMP MIB 테이블 개념: 행(인스턴스)과 열(컬럼 OID) 구조
- SharpSnmpLib 문서: SNMP 요청 처리 방법

---

## 6) 변경 이력

- **2024-12-XX**: MIB 탭 초기 구현 완료
  - MibTreeNode 모델 생성 (Core 레이어)
  - MibService.GetMibTree() 구현
  - MIB 탭 UI 구현 (TreeView + 상세 정보 패널)
  - Right-Click 메뉴 구현 (Get/Get Next/Walk/Copy)

Mib_file import 방법
SNMPc 프로그램에서 MIB 파일을 로드하는 방법은 파일을 프로그램이 인식하는 디렉터리에 복사한 다음, 프로그램 내의 MIB 컴파일러를 통해 데이터베이스에 추가하는 방식입니다. 
다음 단계에 따라 MIB 파일을 로드할 수 있습니다. 
SNMPc에 MIB 파일 로드하는 단계
MIB 파일 준비 및 이름 확인:
장비 제조사에서 제공하는 MIB 파일을 다운로드합니다.
*.mib 이나 *.txt를 인식하게 합니다.
MIB 파일 복사:
SNMPc가 설치된 디렉터리 내의 mibfiles 하위 디렉터리로 MIB 파일을 복사합니다.
기본 설치 경로: C:\Program Files\SNMPc Network Manager\mibfiles
SNMPc 콘솔 실행:
SNMPc Enterprise Server 시스템 작업이 중지된 상태인지 확인하고 필요한 경우 [Windows Start 메뉴 > Programs > SNMPc Network Manager > Shutdown System]을 사용하여 중지합니다.
관리자 권한으로 SNMPc 콘솔을 실행하고 로그인합니다.
MIB 컴파일러 열기:
SNMPc 콘솔 메뉴에서 Config (구성) > MIB Database (MIB 데이터베이스)를 선택합니다.
Compile Mibs 창이 나타납니다. 
새 MIB 파일 추가:
Compile Mibs 창에서 Add (추가) 버튼을 클릭합니다.
파일 목록에서 복사한 MIB 파일을 찾아 하이라이트하고 OK를 클릭하여 컴파일 목록에 추가합니다. Ctrl 키를 누른 채로 여러 파일을 동시에 선택할 수 있습니다.
MIB 컴파일:
다시 Compile Mibs 창으로 돌아와서 Compile (컴파일) 버튼을 클릭합니다.
컴파일 과정이 진행되며, 완료될 때까지 시간이 걸릴 수 있습니다.
컴파일 중 오류나 경고가 발생하면 로그 파일의 History 탭에서 확인할 수 있습니다. 일반적으로 누락된 다른 MIB 파일(종속성 문제)이 원인일 수 있으며, 이 경우 해당 종속성 파일을 먼저 로드해야 합니다.
확인:
컴파일이 성공적으로 완료되면 MIB 데이터베이스에 새 OID(Object Identifier) 정보가 추가됩니다.
Tools 메뉴 하위의 MIB Browser (MIB 브라우저)에서 새로 추가된 MIB 항목을 확인할 수 있습니다. 
이 과정을 통해 SNMPc에서 사용자 지정 MIB 정보를 활용하여 장비를 모니터링하거나 트랩(Trap)을 분석할 수 있습니다. 

빌드가 성공했습니다. SNMPc 스타일의 MIB Database 메뉴와 Compile Mibs 다이얼로그를 구현했습니다.
구현 완료 내용
1. Config 메뉴 추가
MainWindow.xaml에 Config 메뉴 추가
Config > MIB Database... 메뉴 항목 추가
2. Compile Mibs 다이얼로그
파일: SnmpNms.UI/Views/Dialogs/CompileMibsDialog.xaml(.cs)
기능:
MIB 파일 목록 표시 (ListBox)
Add 버튼: 파일 다이얼로그로 MIB 파일 추가 (다중 선택 가능)
Remove 버튼: 선택된 파일 제거
Clear 버튼: 모든 파일 제거
Compile 버튼: 선택된 MIB 파일 컴파일
History 탭: 컴파일 진행 상황 및 결과 로그 표시
3. 동작 방식
Config > MIB Database... 메뉴 클릭
Compile Mibs 창이 열림
기존 MIB 디렉터리의 파일이 자동으로 목록에 로드됨
Add 버튼으로 추가 MIB 파일 선택 가능
Compile 버튼 클릭 시 선택된 파일들이 컴파일됨
컴파일 완료 후 MIB 트리가 자동으로 새로고침됨
4. 컴파일 결과
성공/실패 개수 표시
각 파일별 컴파일 상태가 History 탭에 기록됨
오류 발생 시 상세 메시지 표시
이제 SNMPc와 유사한 방식으로 MIB 파일을 관리하고 컴파일할 수 있습니다.

---

## 7) MIB View 필터링 기능 및 문제 분석

### 7.1 디바이스 선택에 따른 MIB View 필터링

#### 구현 내용
- **파일**: `SnmpNms.UI/MainWindow.xaml.cs`, `SnmpNms.Core/Models/MibTreeNode.cs`, `SnmpNms.UI/Views/SidebarMibView.xaml`
- **변경 사항**:
  - `MibTreeNode`에 `IsVisible` 속성 추가
  - `FilterMibTreeByDevice` 메서드 추가
  - `FilterMibTreeNode` 재귀 메서드 추가
  - `ResetMibTreeFilter` 메서드 추가
  - `SidebarMibView.xaml`에 `Visibility` 바인딩 추가

#### 동작 방식
1. 디바이스 선택 시:
   - 디바이스의 `SysObjectId`에서 Enterprise OID 추출 (예: `1.3.6.1.4.1.3930.36`)
   - Private 노드의 자식 중 해당 Enterprise OID와 일치하는 노드만 표시
   - 부모 노드(예: `nel`)는 자식이 표시되면 자동으로 표시

2. 디바이스 선택 해제 시:
   - 모든 노드 표시 (`ResetMibTreeFilter`)

### 7.2 문제 분석: nel 하위 노드가 사라지는 문제

#### 증상
디바이스를 선택하면 `nel` 노드(1.3.6.1.4.1.3930)는 보이지만 그 하위 노드(mve5000, mvd5000)가 사라짐

#### 원인 분석
1. **필터링 로직의 문제**:
   - `FilterMibTreeNode`에서 `nel` 노드(1.3.6.1.4.1.3930)는 `enterpriseOid`(예: 1.3.6.1.4.1.3930.36)와 정확히 일치하지 않음
   - `nel` 노드는 `enterpriseOid`의 부모이므로 `isMatch = false`
   - `hasMatchingChild`를 확인하는데, 재귀적으로 자식을 먼저 필터링하므로:
     - 자식(mve5000, mvd5000)이 매칭되면 `hasMatchingChild = true`가 되어야 함
     - 하지만 자식이 매칭되지 않으면 `hasMatchingChild = false`가 되어 `nel` 노드가 숨겨짐

2. **필터링 전 초기화 문제**:
   - `ResetMibTreeNodeFilter(rootNode)`를 호출하여 모든 노드를 먼저 표시한 후 필터링
   - 하지만 필터링 로직에서 `nel` 노드가 자식이 없으면 숨겨지는 문제가 있음

#### 해결 방안
1. **부모 노드 예외 처리 추가**:
   - `nel` 노드(1.3.6.1.4.1.3930)는 항상 표시하도록 예외 처리 추가
   - 또는 `enterpriseOid`의 부모 노드는 항상 표시하도록 로직 수정

2. **필터링 로직 개선**:
   - `nel` 노드의 OID가 `enterpriseOid`의 부모인지 확인하는 로직 추가
   - 부모 노드인 경우 자식이 매칭되면 항상 표시

#### 현재 상태
- `ResetMibTreeNodeFilter(rootNode)`를 호출하여 모든 노드를 먼저 표시한 후 필터링
- 하지만 필터링 로직에서 `nel` 노드가 자식이 없으면 숨겨지는 문제가 있음
- **추가 작업 필요**: 부모 노드 예외 처리 추가

### 7.3 문제 분석: mvd5000이 IMPORTS로 표시되는 문제

#### 증상
MIB View에서 mvd5000 노드가 "IMPORTS"로 표시됨

#### 원인 분석
1. **MIB 파일 파싱 문제**:
   - MIB 파일에서 "IMPORTS" 키워드가 OID로 잘못 파싱되었을 가능성
   - 정규식이 대문자로 시작하는 키워드를 매칭했을 수 있음

2. **트리 빌드 시 이름 할당 문제**:
   - `BuildTreeFromOids`에서 중간 세그먼트 이름을 찾을 때 `_oidToName.TryGetValue(fullOid, out var segmentName)`를 사용
   - 만약 `1.3.6.1.4.1.3930.37`에 대한 이름이 "IMPORTS"로 잘못 등록되어 있다면 그 이름이 사용됨

3. **이미 등록된 잘못된 데이터**:
   - `Register` 메서드에서 키워드 필터링을 추가했지만, 이미 등록된 데이터는 남아있을 수 있음

#### 해결 방안
1. **Register 메서드 개선** (완료):
   - "IMPORTS", "EXPORTS", "FROM", "BEGIN", "END" 등 키워드는 등록하지 않음
   - 소문자로 시작하지 않는 이름도 등록하지 않음

2. **BuildTreeFromOids 개선** (완료):
   - 찾은 이름이 유효한지 확인 (소문자로 시작하는지, 키워드가 아닌지)
   - 유효하지 않은 이름이면 세그먼트 번호 사용

3. **MIB 파일 파서 정규식 개선** (완료):
   - `OBJECT IDENTIFIER`, `MODULE-IDENTITY`, `OBJECT-TYPE` 파싱 시 소문자로 시작하는 이름만 매칭
   - "IMPORTS", "EXPORTS" 같은 대문자 키워드는 파싱되지 않음

#### 현재 상태
- `Register` 메서드에서 키워드 필터링 추가 완료
- `BuildTreeFromOids`에서 이름 검증 강화 완료
- MIB 파일 파서 정규식 개선 완료
- 하지만 이미 등록된 잘못된 데이터는 남아있을 수 있음 (애플리케이션 재시작 필요)

---

## 8) 변경 이력

- **2024-12-XX**: MIB 탭 초기 구현 완료
  - MibTreeNode 모델 생성 (Core 레이어)
  - MibService.GetMibTree() 구현
  - MIB 탭 UI 구현 (TreeView + 상세 정보 패널)
  - Right-Click 메뉴 구현 (Get/Get Next/Walk/Copy)

- **2024-12-XX**: MIB View 필터링 기능 추가
  - 디바이스 선택에 따른 MIB View 필터링 구현
  - MIB 파일 파서 개선 (키워드 필터링)
  - 트리 빌드 시 이름 검증 강화
  - 문제 분석 및 해결 방안 문서화