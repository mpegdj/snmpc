
# Map Object Add 기능 구현

## 1. 개요

Map View 탭에서 Device, Subnet, Goto 객체를 추가할 수 있는 버튼을 구현했다.
기존 `MapObjectPropertiesDialog`를 재사용하여 Discovery와 동일한 UX를 제공한다.

## 2. 문제 상황

### 2.1 UI 크래시 (NullReferenceException)

**증상:**
앱 시작 시 크래시 발생

**원인:**
`MapViewControl.xaml`에서 `CheckBox`의 `IsChecked="True"` 설정 시 `Checked` 이벤트가 발생하는데,
이 시점에 `GridCanvas`와 `MapCanvas`가 아직 초기화되지 않아서 `NullReferenceException` 발생

**스택 트레이스:**
```
System.NullReferenceException: Object reference not set to an instance of an object.
   at MapViewControl.DrawGrid() in MapViewControl.xaml.cs:line 61
   at MapViewControl.ShowGrid_Changed()
   ... (XAML 로드 중 IsChecked="True" 설정 시 이벤트 발생)
```

**해결:**
`DrawGrid()` 메서드 시작 부분에 null 체크 추가

```csharp
private void DrawGrid()
{
    // XAML 초기화 중에는 GridCanvas/MapCanvas가 아직 null일 수 있음
    if (GridCanvas == null || MapCanvas == null) return;
    
    GridCanvas.Children.Clear();
    // ...
}
```

## 3. 구현 내용

### 3.1 툴바에 Add Object 버튼 추가

**파일:** `SnmpNms.UI/Views/MapView/MapViewControl.xaml`

```xml
<Separator/>
<Button Content="+ Device" Click="AddDevice_Click" Padding="8,2" ToolTip="Add Device"/>
<Button Content="+ Subnet" Click="AddSubnet_Click" Padding="8,2" ToolTip="Add Subnet"/>
<Button Content="+ Goto" Click="AddGoto_Click" Padding="8,2" ToolTip="Add Goto Link"/>
```

### 3.2 버튼 클릭 핸들러 구현

**파일:** `SnmpNms.UI/Views/MapView/MapViewControl.xaml.cs`

```csharp
// 외부 서비스 (MainWindow에서 주입)
public ISnmpClient? SnmpClient { get; set; }
public ITrapListener? TrapListener { get; set; }

#region Add Object

private void AddDevice_Click(object sender, RoutedEventArgs e)
{
    ShowAddObjectDialog(MapObjectType.Device);
}

private void AddSubnet_Click(object sender, RoutedEventArgs e)
{
    ShowAddObjectDialog(MapObjectType.Subnet);
}

private void AddGoto_Click(object sender, RoutedEventArgs e)
{
    ShowAddObjectDialog(MapObjectType.Goto);
}

private void ShowAddObjectDialog(MapObjectType objectType)
{
    var vm = TryGetVm();
    if (vm == null) return;

    var dialog = new MapObjectPropertiesDialog(objectType, SnmpClient, TrapListener)
    {
        Owner = Window.GetWindow(this)
    };

    if (dialog.ShowDialog() == true)
    {
        var result = dialog.Result;
        
        // 선택된 Subnet이 있으면 그곳에 추가, 없으면 DefaultSubnet에 추가
        var targetSubnet = vm.SelectedMapNodes.FirstOrDefault(n => 
            n.NodeType is MapNodeType.Subnet or MapNodeType.RootSubnet) ?? vm.DefaultSubnet;

        switch (result.Type)
        {
            case MapObjectType.Device:
                var target = new UiSnmpTarget
                {
                    IpAddress = result.IpOrHost,
                    Port = result.Port,
                    Alias = result.Alias,
                    Device = result.Device,
                    Community = result.ReadCommunity,
                    Version = result.SnmpVersion,
                    Timeout = result.TimeoutMs,
                    Retries = result.Retries,
                    PollingProtocol = result.PollingProtocol
                };
                var deviceNode = vm.AddDeviceToSubnet(target, targetSubnet);
                vm.AddSystemInfo($"[Map] Device added: {target.DisplayName} to {targetSubnet.Name}");
                break;

            case MapObjectType.Subnet:
                var subnetName = string.IsNullOrWhiteSpace(result.Alias) ? "New Subnet" : result.Alias;
                var subnetNode = vm.AddSubnet(subnetName, targetSubnet);
                vm.AddSystemInfo($"[Map] Subnet added: {subnetName} to {targetSubnet.Name}");
                break;

            case MapObjectType.Goto:
                var gotoName = string.IsNullOrWhiteSpace(result.Alias) ? "Goto" : result.Alias;
                vm.AddGoto(gotoName, result.GotoSubnetName, targetSubnet);
                vm.AddSystemInfo($"[Map] Goto added: {gotoName} -> {result.GotoSubnetName} to {targetSubnet.Name}");
                break;
        }
    }
}

#endregion
```

### 3.3 MainWindow에서 서비스 주입

**파일:** `SnmpNms.UI/MainWindow.xaml.cs`

```csharp
private void InitializeVSCodeUI()
{
    // ... 기존 코드 ...
    
    // MapViewControl에 서비스 주입
    mapViewControl.SnmpClient = _snmpClient;
    mapViewControl.TrapListener = _trapListener;
}
```

## 4. 기능 설명

### 4.1 + Device 버튼
- `MapObjectPropertiesDialog`를 Device 모드로 열기
- IP 주소, Port, SNMP 설정 입력
- Lookup 버튼으로 SNMP GET (sysName, sysDescr, sysObjectID) 자동 채움
- Ping 버튼으로 연결 확인
- OK 클릭 시 선택된 Subnet (또는 DefaultSubnet)에 Device 추가

### 4.2 + Subnet 버튼
- `MapObjectPropertiesDialog`를 Subnet 모드로 열기
- Alias (Subnet 이름) 입력
- OK 클릭 시 선택된 Subnet (또는 DefaultSubnet)에 하위 Subnet 추가

### 4.3 + Goto 버튼
- `MapObjectPropertiesDialog`를 Goto 모드로 열기
- Alias (표시 이름)와 Address (점프할 Subnet 이름) 입력
- OK 클릭 시 선택된 Subnet (또는 DefaultSubnet)에 Goto 링크 추가

## 5. 재사용된 기존 코드

- `MapObjectPropertiesDialog` - 이미 완전하게 구현된 다이얼로그
- `MapObjectType` enum - Device, Subnet, Goto
- `MainViewModel.AddDeviceToSubnet()` - Device 추가
- `MainViewModel.AddSubnet()` - Subnet 추가
- `MainViewModel.AddGoto()` - Goto 추가

## 6. 변경된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `MapViewControl.xaml` | 툴바에 + Device, + Subnet, + Goto 버튼 추가 |
| `MapViewControl.xaml.cs` | DrawGrid() null 체크, Add Object 핸들러, 서비스 속성 추가 |
| `MainWindow.xaml.cs` | MapViewControl에 SnmpClient, TrapListener 주입 |

## 7. 향후 개선 사항

- [ ] 우클릭 컨텍스트 메뉴에서도 Add Object 가능하도록
- [ ] Site 박스에서 직접 + 버튼으로 Device 추가
- [ ] 드래그 앤 드롭으로 Device를 다른 Subnet으로 이동
- [ ] Subnet 삭제 시 하위 Device 처리 (이동 또는 함께 삭제)

