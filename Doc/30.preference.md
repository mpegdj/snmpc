# Preference System Implementation

## Overview
Implemented a persistent preference system to store application settings and the last used map file path. Settings are saved in `Documents/SNMP/preferences.json`.

### Features
1. **Preference Persistence**: Automatically load settings on startup and save on modification.
2. **Auto-Load Map**: Automatically load the last used map file if enabled.
3. **Preferences Dialog**: UI to edit settings (Auto Load, Polling, Default Community, Logging, etc.).
4. **Log Save Control**: Enable/disable automatic log file saving.

## Modifications

### 1. New File: `SnmpNms.UI/Models/AppPreferences.cs`
Defines the preference data model and service for saving/loading JSON.

```csharp
using System.IO;
using System.Text.Json;

namespace SnmpNms.UI.Models;

public class AppPreferences
{
    public string? LastMapFilePath { get; set; }
    public bool AutoLoadLastMap { get; set; } = true;
    public string? DefaultCommunity { get; set; } = "public";
    public int DefaultTimeout { get; set; } = 3000;
    public int PollingInterval { get; set; } = 30;
    public bool AutoStartPolling { get; set; } = false;
    public int TrapListenerPort { get; set; } = 162;
    public bool EnableLogSave { get; set; } = true;
    public int MaxLogLines { get; set; } = 10000;
}

public static class PreferencesService
{
    private static readonly string PreferencesFolder = Path.Combine(
        Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments),
        "SNMP");
    
    private static readonly string PreferencesFile = Path.Combine(PreferencesFolder, "preferences.json");

    public static AppPreferences Load()
    {
        try
        {
            if (!Directory.Exists(PreferencesFolder))
                Directory.CreateDirectory(PreferencesFolder);

            if (File.Exists(PreferencesFile))
            {
                var json = File.ReadAllText(PreferencesFile);
                return JsonSerializer.Deserialize<AppPreferences>(json) ?? new AppPreferences();
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[Preferences] Load error: {ex.Message}");
        }
        return new AppPreferences();
    }

    public static void Save(AppPreferences preferences)
    {
        try
        {
            if (!Directory.Exists(PreferencesFolder))
                Directory.CreateDirectory(PreferencesFolder);

            var options = new JsonSerializerOptions { WriteIndented = true };
            var json = JsonSerializer.Serialize(preferences, options);
            File.WriteAllText(PreferencesFile, json);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[Preferences] Save error: {ex.Message}");
        }
    }

    public static string GetSnmpFolder() => PreferencesFolder;
}
```

### 2. New File: `SnmpNms.UI/Views/Dialogs/PreferencesDialog.xaml`
XAML for the preferences configuration dialog.

```xml
<Window x:Class="SnmpNms.UI.Views.Dialogs.PreferencesDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Preferences" Height="500" Width="600"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="Application Preferences" FontSize="18" FontWeight="Bold" Margin="0,0,0,20"/>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <!-- General Settings -->
                <TextBlock Text="General" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,10"/>
                <Border Background="White" Padding="15" Margin="0,0,0,20" CornerRadius="4">
                    <StackPanel>
                        <CheckBox x:Name="chkAutoLoadMap" Content="Auto-load last map file on startup" Margin="0,0,0,10"/>
                        <CheckBox x:Name="chkAutoStartPolling" Content="Auto-start polling on startup" Margin="0,0,0,10"/>
                    </StackPanel>
                </Border>

                <!-- SNMP Settings -->
                <TextBlock Text="SNMP Defaults" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,10"/>
                <Border Background="White" Padding="15" Margin="0,0,0,20" CornerRadius="4">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="150"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Default Community:" VerticalAlignment="Center" Margin="0,0,0,10"/>
                        <TextBox x:Name="txtDefaultCommunity" Grid.Column="1" Margin="0,0,0,10"/>

                        <TextBlock Text="Default Timeout (ms):" Grid.Row="1" VerticalAlignment="Center" Margin="0,0,0,10"/>
                        <TextBox x:Name="txtDefaultTimeout" Grid.Row="1" Grid.Column="1" Margin="0,0,0,10"/>

                        <TextBlock Text="Polling Interval (sec):" Grid.Row="2" VerticalAlignment="Center" Margin="0,0,0,10"/>
                        <TextBox x:Name="txtPollingInterval" Grid.Row="2" Grid.Column="1" Margin="0,0,0,10"/>

                        <TextBlock Text="Trap Listener Port:" Grid.Row="3" VerticalAlignment="Center"/>
                        <TextBox x:Name="txtTrapPort" Grid.Row="3" Grid.Column="1"/>
                    </Grid>
                </Border>

                <!-- Logging Settings -->
                <TextBlock Text="Logging" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,10"/>
                <Border Background="White" Padding="15" CornerRadius="4">
                    <StackPanel>
                        <CheckBox x:Name="chkEnableLogSave" Content="Enable log file saving" Margin="0,0,0,10"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="150"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Text="Max log lines in memory:" VerticalAlignment="Center"/>
                            <TextBox x:Name="txtMaxLogLines" Grid.Column="1"/>
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
            <Button Content="OK" Width="80" Height="30" Margin="0,0,10,0" Click="BtnOk_Click" IsDefault="True"/>
            <Button Content="Cancel" Width="80" Height="30" Click="BtnCancel_Click" IsCancel="True"/>
        </StackPanel>
    </Grid>
</Window>
```

### 3. New File: `SnmpNms.UI/Views/Dialogs/PreferencesDialog.xaml.cs`
Logic for loading and saving preferences into the UI components.

```csharp
using System.Windows;
using SnmpNms.UI.Models;

namespace SnmpNms.UI.Views.Dialogs;

public partial class PreferencesDialog : Window
{
    public AppPreferences Preferences { get; private set; }

    public PreferencesDialog(AppPreferences currentPreferences)
    {
        InitializeComponent();
        Preferences = currentPreferences;
        LoadPreferences();
    }

    private void LoadPreferences()
    {
        chkAutoLoadMap.IsChecked = Preferences.AutoLoadLastMap;
        chkAutoStartPolling.IsChecked = Preferences.AutoStartPolling;
        txtDefaultCommunity.Text = Preferences.DefaultCommunity ?? "public";
        txtDefaultTimeout.Text = Preferences.DefaultTimeout.ToString();
        txtPollingInterval.Text = Preferences.PollingInterval.ToString();
        txtTrapPort.Text = Preferences.TrapListenerPort.ToString();
        chkEnableLogSave.IsChecked = Preferences.EnableLogSave;
        txtMaxLogLines.Text = Preferences.MaxLogLines.ToString();
    }

    private void BtnOk_Click(object sender, RoutedEventArgs e)
    {
        try
        {
            Preferences.AutoLoadLastMap = chkAutoLoadMap.IsChecked ?? true;
            Preferences.AutoStartPolling = chkAutoStartPolling.IsChecked ?? false;
            Preferences.DefaultCommunity = txtDefaultCommunity.Text;
            Preferences.DefaultTimeout = int.Parse(txtDefaultTimeout.Text);
            Preferences.PollingInterval = int.Parse(txtPollingInterval.Text);
            Preferences.TrapListenerPort = int.Parse(txtTrapPort.Text);
            Preferences.EnableLogSave = chkEnableLogSave.IsChecked ?? true;
            Preferences.MaxLogLines = int.Parse(txtMaxLogLines.Text);

            DialogResult = true;
            Close();
        }
        catch (Exception ex)
        {
            MessageBox.Show($"Invalid input: {ex.Message}", "Error", MessageBoxButton.OK, MessageBoxImage.Error);
        }
    }

    private void BtnCancel_Click(object sender, RoutedEventArgs e)
    {
        DialogResult = false;
        Close();
    }
}
```

### 4. Modified: `SnmpNms.UI/MainWindow.xaml`
Added the Edit menu with Preferences item.

**Before:**
```xml
<MenuItem Header="_File">
    ... (File items)
    <MenuItem Header="E_xit" Click="MenuExit_Click"/>
</MenuItem>
<MenuItem Header="_View">
```

**After:**
```xml
<MenuItem Header="_File">
    ... (File items)
    <MenuItem Header="E_xit" Click="MenuExit_Click"/>
</MenuItem>
<MenuItem Header="_Edit">
    <MenuItem Header="Preferences..." Click="MenuPreferences_Click"/>
</MenuItem>
<MenuItem Header="_View">
```

### 5. Modified: `SnmpNms.UI/ViewModels/MainViewModel.cs`
Updated `RootSubnet` to include a setter that refreshes the `MapRoots` collection. This allows replacing the entire map tree when loading a new file.

**Before:**
```csharp
public ObservableCollection<MapNode> MapRoots { get; } = new();
public MapNode RootSubnet { get; }
public MapNode DefaultSubnet { get; }

public MainViewModel()
{
    RootSubnet = new MapNode(MapNodeType.RootSubnet, "Root Subnet");
    DefaultSubnet = new MapNode(MapNodeType.Subnet, "Default");
    RootSubnet.AddChild(DefaultSubnet);
    MapRoots.Add(RootSubnet);
    ...
```

**After:**
```csharp
public ObservableCollection<MapNode> MapRoots { get; } = new();

private MapNode _rootSubnet;
public MapNode RootSubnet 
{ 
    get => _rootSubnet;
    set
    {
        if (_rootSubnet == value) return;
        _rootSubnet = value;
        OnPropertyChanged();
        
        // Root가 바뀌면 MapRoots 컬렉션 동기화
        MapRoots.Clear();
        if (_rootSubnet != null)
        {
            MapRoots.Add(_rootSubnet);
        }
    }
}

public MapNode DefaultSubnet { get; set; }

public MainViewModel()
{
    RootSubnet = new MapNode(MapNodeType.RootSubnet, "Root Subnet");
    DefaultSubnet = new MapNode(MapNodeType.Subnet, "Default");
    RootSubnet.AddChild(DefaultSubnet); // Note: MapRoots.Add is removed as it is handled by the setter
    ...
```

### 6. Modified: `SnmpNms.UI/MainWindow.xaml.cs`
Implemented loading preferences on startup, the preferences menu handler, and updating preferences when opening/saving files.

**Before (Constructor):**
```csharp
// 디버그 출력을 앱 내부로 리다이렉트
InitializeDebugRedirector();

_vm.Debug.LogSystem("[System] SNMPc initialized. External console removed.");
```

**After (Constructor):**
```csharp
// 디버그 출력을 앱 내부로 리다이렉트
InitializeDebugRedirector();

_vm.Debug.LogSystem("[System] SNMPc initialized. External console removed.");

// Preferences 로드
_preferences = PreferencesService.Load();
ApplyPreferences();

// 마지막 맵 파일 자동 로드
if (_preferences.AutoLoadLastMap && !string.IsNullOrEmpty(_preferences.LastMapFilePath))
{
    if (File.Exists(_preferences.LastMapFilePath))
    {
        LoadMapFile(_preferences.LastMapFilePath);
    }
}
```

**After (File Handler Implementation):**
```csharp
private void ApplyPreferences()
{
    // Apply preferences to UI and services
    if (cmbCommunity != null && !string.IsNullOrEmpty(_preferences.DefaultCommunity))
    {
        cmbCommunity.Text = _preferences.DefaultCommunity;
    }

    // Apply log settings
    if (_preferences.EnableLogSave)
    {
        _vm.LogSaveService.IsEnabled = true;
    }
}

private void MenuPreferences_Click(object sender, RoutedEventArgs e)
{
    var dialog = new PreferencesDialog(_preferences);
    if (dialog.ShowDialog() == true)
    {
        _preferences = dialog.Preferences;
        PreferencesService.Save(_preferences);
        ApplyPreferences();
        _vm.AddSystemInfo("[System] Preferences saved successfully.");
    }
}

private void LoadMapFile(string filePath)
{
    try
    {
        var mapData = _mapDataService.LoadFromFile(filePath);
        if (mapData != null)
        {
            _vm.RootSubnet = mapData;
            _currentFilePath = filePath;
            _isModified = false;
            _vm.AddSystemInfo($"[System] Map loaded from {filePath}");
        }
    }
    catch (Exception ex)
    {
        _vm.AddEvent(EventSeverity.Error, null, $"[System] Failed to load map: {ex.Message}");
    }
}
```

**Updated `MenuFileOpen_Click` & `SaveToFile` to update preferences:**
```csharp
// Update preferences
_preferences.LastMapFilePath = dlg.FileName; // or filePath
PreferencesService.Save(_preferences);
```
