# Map View Alarm Status Issue
색이 연해서 안보였던것

## Issue Description
- Polling works correctly (logs are generated).
- However, when a polling error occurs, the device color in Map View properly changes to Red (Error status) ONLY after fixing the `LoadMapFile` logic.
- Previously, the color did not change because the `DeviceNodes` collection was not refreshed upon map loading.
- **Trap Handling Issue**: Even if a trap is received, the device status in Map View is not updated to reflect the trap's severity (e.g., Error Trap -> Red, Info Trap -> Green).

## Completed Fixes

### 1. Fix `MainWindow.xaml.cs` - `LoadMapFile`
Updated `LoadMapFile` to refresh `DeviceNodes`, restoring the link between Polling Service and UI.

```csharp
private void LoadMapFile(string filePath)
{
    // ...
    _vm.RootSubnet = mapData;
    
    // Refresh DeviceNodes collection to ensure Polling/Trap listeners can find UI nodes
    _vm.DeviceNodes.Clear();
    CollectDeviceNodes(_vm.RootSubnet);
    // ...
}
```

### 2. Robust Input Handling
Updated `UiSnmpTarget.IpAddress` setter to Trim whitespace, preventing key mismatch errors.

```csharp
public string IpAddress
{
    get => _ipAddress;
    set
    {
        var newVal = value?.Trim() ?? ""; // Added Trim()
        if (_ipAddress == newVal) return;
        // ...
    }
}
```

### 3. Debugging Support
Added system log output when `SetDeviceStatus` fails to find a target node, aiding in diagnosis.

## Next Steps: Trap Status Synchronization

### Objective
Update the device status in Map View based on the severity of received traps.
- **Error Level Trap**: Set Device Status to `Down` (Red).
- **Other Traps (Info, Notice, Warning)**: Set Device Status to `Up` (Green).

### Plan (Latest Update)
Refactored `TrapListener_OnTrapReceived` in `MainWindow.xaml.cs` to map Trap Severity to Device Status.
- **Updated Logic**: Error & Warning & Notice -> `Down` (Red). (Due to user feedback that 'Notice' contained errors)
- Info -> `Up` (Green).

---

# NMS Map View Alarm & Status Visualization System (System Description)

This section details how the NMS detects device errors via SNMP Polling and Traps, and how these events are propagated to update the device status (color) in the Map View.

## 1. Overview
The system maintains the health status of network devices using two mechanisms:
1.  **Active Monitoring (Polling)**: The NMS periodically sends requests to devices. If a device fails to respond (Timeout), it is marked as **Down**.
2.  **Passive Monitoring (Trap)**: The NMS listens for unsolicited messages from devices. If a Trap with high severity (Error/Warning/Notice) is received, the device is marked as **Down**.

Changes in status are immediately reflected in the Map View, changing the device icon/background color (Red for Down, Green for Up) and propagating the status to parent groups.

## 2. Detailed Process Flow

### Step 1: Initialization & Linking
- When a map file is loaded, the system builds a visual tree (`MapRoots`) and a logical lookup list (`DeviceNodes`).
- Validating the `LoadMapFile` logic ensures that the Polling Service and Trap Listener can find the corresponding UI elements (`MapNode`) using the device's IP address.

### Step 2: Event Detection
- **Polling**: The `PollingService` runs in the background. If a ping/SNMP request fails, it generates a `PollingResult` with `DeviceStatus.Down`.
- **Trap**: The `TrapListener` waits on port 162. When a packet arrives, it parses the variable bindings to determine the event's severity.

### Step 3: Status Update Logic (MainWindow)
- The event handler (`PollingService_OnPollingResult` or `TrapListener_OnTrapReceived`) receives the raw event.
- It determines the target device in the UI by matching the **IP Address**.
- It decides the new status:
    - **Polling Timeout** → `Down`
    - **Trap (Error/Warning/Notice)** → `Down`
    - **Trap (Info) / Polling Success** → `Up`
- The `Status` property of the `UiSnmpTarget` object is updated.

### Step 4: Visual Propagation (MapNode)
- The `MapNode` observes changes in its `Target.Status`.
- When changed, it triggers `RecomputeEffectiveStatus()` for itself and its parent.
- **Priority Logic**: If a group contains multiple devices, the status priority is **Down > Unknown > Up**. A single Down device turns the entire group Red.

## 3. Code Level Description

### A. Polling Status Update
**File**: `SnmpNms.UI/MainWindow.xaml.cs`
**Method**: `PollingService_OnPollingResult`

Depending on the polling result (`e.Status`), the system updates the UI.

```csharp
private void PollingService_OnPollingResult(object? sender, PollingResult e)
{
    // 1. Check Result
    if (e.Status == DeviceStatus.Up) {
        // Handle Success (Set to Up)
        SetDeviceStatus($"{e.Target.IpAddress}:{e.Target.Port}", DeviceStatus.Up);
    }
    else {
        // 2. Handle Failure (Set to Down)
        // Uses SetDeviceStatus to find the node and update it.
        if (!SetDeviceStatus($"{e.Target.IpAddress}:{e.Target.Port}", DeviceStatus.Down)) {
            // Log warning if node is not found in the map
            _vm.Debug.LogSystem($"[Warning] Map node not found...");
        }
        // ... Log error event ...
    }
}
```

**Method**: `SetDeviceStatus`
Helper method to find the UI node and update status.

```csharp
private bool SetDeviceStatus(string deviceKey, DeviceStatus status)
{
    // FindTargetByKey recursively searches the MapRoots tree for a matching IP:Port
    var target = FindTargetByKey(_vm.RootSubnet, deviceKey);
    if (target is not null) 
    {
        target.Status = status; // Triggers UI update via INotifyPropertyChanged
        _vm.RootSubnet.RecomputeEffectiveStatus(); // Propagate to parents
        return true;
    }
    return false;
}
```

### B. Trap Status Update
**File**: `SnmpNms.UI/MainWindow.xaml.cs`
**Method**: `TrapListener_OnTrapReceived`

Parses the incoming trap and updates the status based on severity.

```csharp
private void TrapListener_OnTrapReceived(object? sender, TrapEvent e)
{
    // 1. Parse Severity from Trap Variables (Index 2 usually contains Level)
    var severity = EventSeverity.Info;
    // ... Parsing logic (Error, Warning, Notice, Info) ...

    // 2. Find matching DeviceNode by IP
    var deviceNode = _vm.DeviceNodes.FirstOrDefault(n => n.Target?.IpAddress == e.SourceIpAddress);
    
    if (deviceNode?.Target != null)
    {
        // 3. Determine Status based on Severity
        // CURRENT LOGIC: Error/Warning/Notice -> Down (Red), Others -> Up (Green)
        var newStatus = (severity == EventSeverity.Error || \
                         severity == EventSeverity.Warning || \
                         severity == EventSeverity.Notice) 
                        ? DeviceStatus.Down : DeviceStatus.Up;
        
        // 4. Update UI on Dispatcher Thread
        System.Windows.Application.Current.Dispatcher.Invoke(() =>
        {
            deviceNode.Target.Status = newStatus;
            _vm.RootSubnet.RecomputeEffectiveStatus();
        });
    }
    // ... Log event ...
}
```

### C. UI Binding & Propagation
**File**: `SnmpNms.UI/Models/MapNode.cs`
**Method**: `RecomputeEffectiveStatus`

Ensures that the group/folder color reflects the most critical status of its children.

```csharp
public void RecomputeEffectiveStatus()
{
    if (NodeType == MapNodeType.Device) {
        EffectiveStatus = Target?.Status ?? DeviceStatus.Unknown;
        return;
    }

    // Group Logic: Check all children
    var statuses = Children.Select(c => c.EffectiveStatus).ToList();
    
    // Priority: Down (Red) > Unknown (Gray) > Up (Green)
    if (statuses.Any(s => s == DeviceStatus.Down)) 
        EffectiveStatus = DeviceStatus.Down; // Logic ensures Red if ANY child is Down
    else if (statuses.Any(s => s == DeviceStatus.Unknown)) 
        EffectiveStatus = DeviceStatus.Unknown;
    else 
        EffectiveStatus = DeviceStatus.Up;
}
```
